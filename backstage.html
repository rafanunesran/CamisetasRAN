<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backstage - UniformeGestor</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#2E3A87', foreground: '#ffffff' },
                        secondary: { DEFAULT: '#E9ECEF', foreground: '#1f2937' },
                        accent: { DEFAULT: '#9B5DE5', foreground: '#ffffff' },
                        muted: { DEFAULT: '#f3f4f6', foreground: '#6b7280' },
                        destructive: { DEFAULT: '#ef4444', foreground: '#ffffff' },
                        background: '#ffffff',
                        foreground: '#020817',
                        border: '#e5e7eb',
                    },
                    fontFamily: {
                        headline: ['"PT Sans"', 'sans-serif'],
                        body: ['"PT Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Scripts do Google para Upload no Drive -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom-color: #2E3A87; color: #020817; }
        /* Esconde a barra de rolagem mas mantém a funcionalidade */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <script>
        // Proteção de rota simples
        if (sessionStorage.getItem('auth') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body class="font-body antialiased bg-background overflow-hidden flex h-screen">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-16 hover:w-64 transition-[width] duration-300 ease-in-out bg-primary text-primary-foreground hidden lg:flex flex-col z-50 shadow-2xl overflow-hidden group">
        <div class="h-16 flex items-center border-b border-white/10 whitespace-nowrap relative">
            <div class="w-16 flex justify-center items-center shrink-0">
            <i data-lucide="graduation-cap" class="h-8 w-8 text-accent shrink-0"></i>
            </div>
            <span class="text-xl font-bold font-headline opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-100 absolute left-16">Backstage</span>
        </div>
        <nav class="flex-1 space-y-1 py-4 flex flex-col overflow-hidden">
            <button onclick="switchTab('overview')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="layout-dashboard" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Dashboard</span>
            </button>
            <button onclick="switchTab('clients')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="users" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Clientes</span>
            </button>
            <button onclick="switchTab('schools')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="building-2" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Escolas/Rev</span>
            </button>
            <button onclick="switchTab('products')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="shirt" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Produtos</span>
            </button>
            <button onclick="switchTab('inventory')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="package" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Estoque</span>
            </button>
            <button onclick="switchTab('production')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="factory" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Produção</span>
            </button>
            <button onclick="switchTab('errors')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="alert-triangle" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Erros de Produção</span>
            </button>
            <button onclick="switchTab('transfers')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="arrow-right-left" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Repasses</span>
            </button>
            <button onclick="switchTab('reports')" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium transition-colors duration-200 relative">
                <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="file-bar-chart" class="h-5 w-5"></i></div>
                <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Relatórios</span>
            </button>
            
            <div class="mt-auto pt-4 border-t border-white/10 px-0 pb-4">
                <a href="index.html" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium text-accent transition-colors duration-200 relative">
                    <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="arrow-left" class="h-5 w-5"></i></div>
                    <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Voltar ao Site</span>
                </a>
                <button onclick="logout()" class="w-full flex items-center justify-start h-12 px-0 hover:bg-white/10 text-sm font-medium text-red-300 hover:text-red-100 transition-colors duration-200 relative">
                    <div class="w-16 flex justify-center items-center shrink-0 h-full"><i data-lucide="log-out" class="h-5 w-5"></i></div>
                    <span class="whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75 absolute left-16">Sair</span>
                </button>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-50 lg:ml-16">
        <header class="h-16 bg-white border-b px-8 flex items-center justify-between sticky top-0 z-40">
            <div class="flex items-center gap-4 flex-1 max-w-md">
                <div class="relative w-full">
                    <i data-lucide="search" class="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"></i>
                    <input placeholder="Buscar..." class="pl-9 bg-muted/50 border-none h-9 w-full rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                </div>
            </div>
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-sm font-medium text-gray-600 hover:text-primary flex items-center gap-2 transition-colors mr-2" title="Ir para a Loja">
                    <i data-lucide="store" class="h-4 w-4"></i>
                    <span class="hidden sm:inline">Voltar à Loja</span>
                </a>
                <div class="h-9 w-9 bg-accent rounded-full flex items-center justify-center text-accent-foreground font-bold">AD</div>
            </div>
        </header>

        <div class="p-8 w-full mx-auto space-y-8">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold font-headline text-primary">Painel de Controle</h1>
                    <p class="text-muted-foreground">Bem-vindo ao sistema de gestão UniformeGestor.</p>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="bg-white p-1 h-12 shadow-sm border rounded-md flex mb-6 overflow-x-auto no-scrollbar">
                <button onclick="switchTab('overview')" id="btn-overview" class="tab-btn active h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="layout-dashboard" class="h-4 w-4"></i> Visão Geral
                </button>
                <button onclick="switchTab('clients')" id="btn-clients" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="users" class="h-4 w-4"></i> Clientes
                </button>
                <button onclick="switchTab('schools')" id="btn-schools" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="building-2" class="h-4 w-4"></i> Escolas/Rev
                </button>
                <button onclick="switchTab('products')" id="btn-products" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="shirt" class="h-4 w-4"></i> Produtos
                </button>
                <button onclick="switchTab('inventory')" id="btn-inventory" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="package" class="h-4 w-4"></i> Estoque
                </button>
                <button onclick="switchTab('production')" id="btn-production" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="factory" class="h-4 w-4"></i> Produção
                </button>
                <button onclick="switchTab('errors')" id="btn-errors" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="alert-triangle" class="h-4 w-4"></i> Erros de Produção
                </button>
                <button onclick="switchTab('transfers')" id="btn-transfers" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="arrow-right-left" class="h-4 w-4"></i> Repasses
                </button>
                <button onclick="switchTab('reports')" id="btn-reports" class="tab-btn h-full px-4 flex items-center gap-2 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground transition-colors whitespace-nowrap">
                    <i data-lucide="file-bar-chart" class="h-4 w-4"></i> Relatórios
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="rounded-lg border bg-white shadow-sm p-6 col-span-1 md:col-span-2 lg:col-span-1">
                        <h3 class="text-sm font-medium text-muted-foreground">Vendas do Mês</h3>
                        <div class="text-2xl font-bold text-primary mt-2" id="dashSalesMonth">R$ 0,00</div>
                        <p class="text-xs text-muted-foreground mt-1">Pedidos confirmados este mês</p>
                    </div>
                    <div class="rounded-lg border bg-white shadow-sm p-6 col-span-1 md:col-span-2 lg:col-span-1">
                        <h3 class="text-sm font-medium text-muted-foreground">Lucro Líquido (Est.)</h3>
                        <div class="text-2xl font-bold text-green-600 mt-2" id="dashNetProfit">R$ 0,00</div>
                        <p class="text-xs text-muted-foreground mt-1" title="Total - Materiais - Repasses (Escola/Prod)">Receita - Custos - Repasses Ext.</p>
                    </div>
                    <div class="rounded-lg border bg-white shadow-sm p-6 col-span-1 md:col-span-2 lg:col-span-1">
                        <h3 class="text-sm font-medium text-muted-foreground">Total de Repasses</h3>
                        <div class="text-2xl font-bold text-orange-600 mt-2" id="dashTotalTransfers">R$ 0,00</div>
                        <p class="text-xs text-muted-foreground mt-1">Escola + Produção + ADM</p>
                    </div>
                </div>
                
                <!-- Lists Columns -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[calc(100vh-350px)] min-h-[400px]">
                    <!-- Orçamentos -->
                    <div class="flex flex-col rounded-lg border bg-white shadow-sm h-full overflow-hidden">
                        <div class="p-3 border-b bg-gray-50 font-semibold text-gray-700 flex justify-between items-center">
                            <span>Orçamentos</span>
                            <button onclick="openOrderModal()" class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary/90 flex items-center gap-1"><i data-lucide="plus" class="h-3 w-3"></i> Novo</button>
                        </div>
                        <div id="dashListBudget" class="p-2 overflow-y-auto flex-1 space-y-2 bg-gray-50/50"></div>
                    </div>
                    
                    <!-- Pendentes -->
                    <div class="flex flex-col rounded-lg border bg-white shadow-sm h-full overflow-hidden">
                        <div class="p-3 border-b bg-yellow-50 font-semibold text-yellow-800">Pendentes</div>
                        <div id="dashListPending" class="p-2 overflow-y-auto flex-1 space-y-2 bg-yellow-50/30"></div>
                    </div>

                    <!-- Em Produção -->
                    <div class="flex flex-col rounded-lg border bg-white shadow-sm h-full overflow-hidden">
                        <div class="p-3 border-b bg-blue-50 font-semibold text-blue-800">Em Produção</div>
                        <div id="dashListProduction" class="p-2 overflow-y-auto flex-1 space-y-2 bg-blue-50/30"></div>
                    </div>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="clients" class="tab-content space-y-6">
                <div class="rounded-lg border bg-white shadow-sm">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="font-semibold">Base de Clientes</h3>
                        <button onclick="openClientModal()" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors">Novo Cliente</button>
                    </div>
                    <div class="p-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-muted-foreground font-medium border-b">
                                <tr><th class="pb-3">Nome</th><th class="pb-3">Telefone</th><th class="pb-3">Parceiro</th><th class="pb-3">Estudante</th><th class="pb-3 text-right">Ações</th></tr>
                            </thead>
                            <tbody id="clients-table-body" class="divide-y">
                                <tr><td colspan="5" class="py-4 text-center text-muted-foreground">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Schools/Resellers Tab -->
            <div id="schools" class="tab-content space-y-6">
                <div class="rounded-lg border bg-white shadow-sm">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="font-semibold">Escolas e Revendedores</h3>
                        <button onclick="openPartnerModal()" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors">Novo Parceiro</button>
                    </div>
                    <div class="p-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-muted-foreground font-medium border-b">
                                <tr><th class="pb-3">Nome Oficial</th><th class="pb-3">Nick name</th><th class="pb-3">Categoria</th><th class="pb-3">Chave Pix</th><th class="pb-3">Status</th><th class="pb-3 text-right">Ações</th></tr>
                            </thead>
                            <tbody id="partners-table-body" class="divide-y">
                                <!-- Dados carregados via Firebase -->
                                <tr><td colspan="5" class="py-4 text-center text-muted-foreground">Carregando parceiros...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content space-y-6">
                <div class="rounded-lg border bg-white shadow-sm">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="font-semibold">Catálogo de Produtos</h3>
                        <div class="flex gap-2">
                            <select id="productFilterPartner" onchange="fetchProducts()" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white focus:outline-none focus:ring-1 focus:ring-primary max-w-[150px]">
                                <option value="">Todas as Escolas</option>
                            </select>
                            <button onclick="openProductModal()" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors">Novo Produto</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-muted-foreground font-medium border-b">
                                <tr><th class="pb-3">Imagem</th><th class="pb-3">Produto</th><th class="pb-3">Parceiro</th><th class="pb-3">Categoria</th><th class="pb-3">Preço</th><th class="pb-3">Status</th><th class="pb-3 text-right">Ações</th></tr>
                            </thead>
                            <tbody class="divide-y">
                                <tbody id="products-table-body" class="divide-y">
                                    <tr><td colspan="7" class="py-4 text-center text-muted-foreground">Carregando produtos...</td></tr>
                                </tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory" class="tab-content space-y-6">
                <div class="rounded-lg border bg-white shadow-sm">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="font-semibold">Gestão de Estoque</h3>
                        <div class="flex gap-2">
                            <select id="inventoryFilterType" onchange="renderInventory()" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="">Todos os Tipos</option>
                                <option value="Malha">Malha</option>
                                <option value="Estampa">Estampa</option>
                                <option value="Insumo">Insumo</option>
                            </select>
                            <button onclick="openMovementsModal()" class="text-xs border border-gray-300 bg-white text-gray-700 px-3 py-1 rounded hover:bg-gray-50 transition-colors flex items-center gap-1"><i data-lucide="history" class="h-3 w-3"></i> Movimentações</button>
                            <button onclick="openPurchaseModal()" class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition-colors flex items-center gap-1"><i data-lucide="shopping-cart" class="h-3 w-3"></i> Nova Compra</button>
                            <button onclick="openInventoryModal()" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors flex items-center gap-1"><i data-lucide="plus" class="h-3 w-3"></i> Novo Item</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-muted-foreground font-medium border-b">
                                <tr><th class="pb-3">Imagem</th><th class="pb-3">Nome</th><th class="pb-3">Tipo</th><th class="pb-3">Custo Unit.</th><th class="pb-3">Estoque</th><th class="pb-3 text-right">Ações</th></tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y">
                                <tr><td colspan="6" class="py-4 text-center text-muted-foreground">Carregando estoque...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Production Tab -->
            <div id="production" class="tab-content space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-lg">Gestão de Pedidos</h3>
                    <button onclick="openOrderModal()" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors flex items-center gap-1">
                        <i data-lucide="plus" class="h-3 w-3"></i> Novo Orçamento
                    </button>
                </div>
                
                <!-- Sub-navegação de Status -->
                <div class="flex border-b overflow-x-auto no-scrollbar">
                    <button onclick="switchProductionStatus('Orçamento')" id="tab-prod-orcamento" class="prod-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary whitespace-nowrap">Orçamentos</button>
                    <button onclick="switchProductionStatus('Pendente')" id="tab-prod-pendente" class="prod-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Pendentes</button>
                    <button onclick="switchProductionStatus('Produção')" id="tab-prod-producao" class="prod-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Em Produção</button>
                    <button onclick="switchProductionStatus('Finalizado')" id="tab-prod-finalizado" class="prod-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Finalizados</button>
                    <button onclick="switchProductionStatus('Entregue')" id="tab-prod-entregue" class="prod-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Entregues</button>
                    <button onclick="switchProductionStatus('Arquivado')" id="tab-prod-arquivado" class="prod-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Arquivados</button>
                </div>
                
                <div class="flex items-center gap-2 py-2 px-1">
                    <span class="text-xs font-medium text-gray-500">Filtrar:</span>
                    <select id="productionFilterPayment" onchange="fetchOrders()" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="">Todos Pagamentos</option>
                        <option value="Pendente">Pagamento Pendente</option>
                        <option value="Pago Parcial">Pago Parcial</option>
                        <option value="Pago Total">Pago Total</option>
                    </select>
                </div>

                <div id="production-actions" class="hidden bg-blue-50 p-2 rounded border border-blue-100 flex justify-between items-center">
                    <span class="text-sm text-blue-800 font-medium"><span id="selected-count">0</span> pedidos selecionados</span>
                    <button onclick="generateMaterialReport()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 flex items-center gap-1"><i data-lucide="clipboard-list" class="h-3 w-3"></i> Gerar Relatório de Materiais</button>
                </div>

                <!-- Container da Lista -->
                <div id="production-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 h-[calc(100vh-300px)] overflow-y-auto content-start">
                    <!-- Cards renderizados via JS -->
                </div>
            </div>

            <!-- Production Errors Tab -->
            <div id="errors" class="tab-content space-y-6">
                <div class="rounded-lg border bg-white shadow-sm">
                    <div class="p-6 border-b">
                        <h3 class="font-semibold">Histórico de Erros de Produção</h3>
                        <p class="text-sm text-muted-foreground">Itens registrados como perda durante a produção.</p>
                    </div>
                    <div class="p-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-muted-foreground font-medium border-b">
                                <tr>
                                    <th class="pb-3">Data</th>
                                    <th class="pb-3">Pedido / Cliente</th>
                                    <th class="pb-3">Produto</th>
                                    <th class="pb-3">Qtd. Perdida</th>
                                    <th class="pb-3">Motivo</th>
                                    <th class="pb-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="errors-table-body" class="divide-y">
                                <tr><td colspan="5" class="py-4 text-center text-muted-foreground">Carregando histórico de erros...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transfers Tab (Repasses) -->
            <div id="transfers" class="tab-content space-y-6">
                <div class="rounded-lg border bg-white shadow-sm">
                    <div class="p-6 border-b flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h3 class="font-semibold">Central de Repasses</h3>
                            <p class="text-sm text-muted-foreground">Gerencie comissões de escolas, pagamentos de produção e lucro administrativo.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="markSelectedAsPaid()" class="text-xs bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 transition-colors flex items-center gap-1">
                                <i data-lucide="check-circle" class="h-3 w-3"></i> Efetivar Pagamentos (<span id="transfer-selected-count">0</span>)
                            </button>
                            <button onclick="openPaymentHistoryModal()" class="text-xs border border-gray-300 bg-white text-gray-700 px-3 py-2 rounded hover:bg-gray-50 transition-colors flex items-center gap-1">
                                <i data-lucide="history" class="h-3 w-3"></i> Histórico
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros e Resumo -->
                    <div class="p-6 bg-gray-50 border-b grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500">Filtrar por Parceiro</label>
                            <select id="transferFilterPartner" onchange="fetchTransfers()" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500">Filtrar por Tipo</label>
                            <select id="transferFilterType" onchange="fetchTransfers()" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="">Todos</option>
                                <option value="Escola">Escola/Revendedor</option>
                                <option value="Produção">Produção</option>
                                <option value="ADM">ADM (Lucro)</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500">Filtrar por Status</label>
                            <select id="transferFilterStatus" onchange="fetchTransfers()" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="">Todos</option>
                                <option value="Aberto">Aberto (Em andamento)</option>
                                <option value="Pendente">Pendente (Pronto p/ Pagar)</option>
                                <option value="Pago">Pago (Efetivado)</option>
                            </select>
                        </div>
                        <div class="flex items-end justify-end">
                            <div class="text-right">
                                <span class="text-xs text-gray-500">Total Filtrado</span>
                                <div class="text-xl font-bold text-primary" id="transferTotalDisplay">R$ 0,00</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-muted-foreground font-medium border-b">
                                <tr>
                                    <th class="pb-3 w-8"><input type="checkbox" onchange="toggleAllTransfers(this)"></th>
                                    <th class="pb-3">Data Pedido</th>
                                    <th class="pb-3">Pedido / Cliente</th>
                                    <th class="pb-3">Beneficiário</th>
                                    <th class="pb-3">Tipo</th>
                                    <th class="pb-3">Valor</th>
                                    <th class="pb-3 text-right">Status</th>
                                </tr>
                            </thead>
                            <tbody id="transfers-table-body" class="divide-y">
                                <tr><td colspan="7" class="py-4 text-center text-muted-foreground">Carregando repasses...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="rounded-lg border bg-white shadow-sm p-6 flex flex-col items-center text-center">
                        <i data-lucide="file-text" class="h-10 w-10 text-primary mb-4"></i>
                        <h3 class="font-semibold mb-2">Relatório de Vendas</h3>
                        <p class="text-sm text-muted-foreground mb-4">Exportar dados de vendas por período.</p>
                        <button class="text-sm bg-secondary hover:bg-secondary/80 px-4 py-2 rounded w-full">Baixar PDF</button>
                    </div>
                    <div class="rounded-lg border bg-white shadow-sm p-6 flex flex-col items-center text-center">
                        <i data-lucide="package-check" class="h-10 w-10 text-primary mb-4"></i>
                        <h3 class="font-semibold mb-2">Relatório de Estoque</h3>
                        <p class="text-sm text-muted-foreground mb-4">Posição atual e previsão de demanda.</p>
                        <button class="text-sm bg-secondary hover:bg-secondary/80 px-4 py-2 rounded w-full">Baixar CSV</button>
                    </div>
                    <div class="rounded-lg border bg-white shadow-sm p-6 flex flex-col items-center text-center">
                        <i data-lucide="banknote" class="h-10 w-10 text-primary mb-4"></i>
                        <h3 class="font-semibold mb-2">Relatório Financeiro</h3>
                        <p class="text-sm text-muted-foreground mb-4">Balanço de repasses e lucros.</p>
                        <button class="text-sm bg-secondary hover:bg-secondary/80 px-4 py-2 rounded w-full">Baixar Excel</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal de Parceiro -->
    <div id="partnerModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-md space-y-4 shadow-xl border border-gray-200">
            <h2 id="modalTitle" class="text-xl font-bold text-primary">Novo Parceiro</h2>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nome Oficial</label>
                <input id="partnerName" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Razão Social ou Nome Completo">
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nick name (Apelido)</label>
                <input id="partnerNickname" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Nome Fantasia ou Apelido">
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Categoria</label>
                <select id="partnerCategory" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="Escola">Escola</option>
                    <option value="Revendedor">Revendedor</option>
                    <option value="Produção">Produção</option>
                    <option value="ADM">ADM</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Chave Pix (Opcional)</label>
                <input id="partnerPix" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="CPF, CNPJ, Email ou Aleatória">
            </div>
            <div class="flex justify-end gap-2 pt-4">
                <button onclick="closePartnerModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Cancelar</button>
                <button id="savePartnerBtn" onclick="savePartner()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cliente -->
    <div id="clientModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-md space-y-4 shadow-xl border border-gray-200">
            <h2 id="clientModalTitle" class="text-xl font-bold text-primary">Novo Cliente</h2>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                <input id="clientName" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Nome completo">
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Telefone</label>
                <input id="clientPhone" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="(00) 00000-0000">
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Parceiro (Escola/Revendedor)</label>
                <select id="clientPartner" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">Selecione um parceiro...</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nome do Estudante (se escola)</label>
                <input id="clientStudent" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Nome do aluno">
            </div>
            <div class="flex justify-end gap-2 pt-4">
                <button onclick="closeClientModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Cancelar</button>
                <button id="saveClientBtn" onclick="saveClient()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Estoque -->
    <div id="inventoryModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-md space-y-4 shadow-xl border border-gray-200">
            <h2 id="inventoryModalTitle" class="text-xl font-bold text-primary">Novo Item de Estoque</h2>
            
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Tipo</label>
                <select id="inventoryType" onchange="toggleInventoryFields()" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="Malha">Malha</option>
                    <option value="Estampa">Estampa</option>
                    <option value="Insumo">Insumo</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nome do Item</label>
                <input id="inventoryName" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Algodão 30.1 ou Estampa Leão">
            </div>

            <div id="inventoryCategoryContainer" class="space-y-2 hidden">
                <label class="text-sm font-medium text-gray-700">Categoria</label>
                <div class="flex gap-2">
                    <select id="inventoryCategory" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Selecione...</option>
                    </select>
                    <button onclick="createNewCategory()" class="px-3 py-2 bg-gray-100 text-gray-700 border border-gray-300 rounded-md hover:bg-gray-200 transition-colors" title="Criar Nova Categoria">
                        <i data-lucide="plus" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>

            <div id="inventoryUsageContainer" class="space-y-2 hidden bg-gray-50 p-3 rounded border border-gray-200">
                <label class="text-sm font-medium text-gray-700 block">Regra de Uso (Automação)</label>
                <select id="inventoryUsageType" onchange="toggleUsageFields()" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="unit">Por Item (Ex: 1 Etiqueta por peça)</option>
                    <option value="batch">Por Lote (Ex: 1 Embalagem a cada 5 peças)</option>
                    <option value="order">Por Pedido (Ex: 1 Brinde por pedido)</option>
                </select>
                
                <div id="usageUnitConfig" class="usage-config hidden text-sm text-gray-600 flex items-center flex-wrap">
                    Usar <input id="usageUnitQty" type="number" value="1" min="1" class="w-16 border border-gray-300 rounded px-2 py-1 mx-2 text-center focus:outline-none focus:ring-1 focus:ring-primary"> unidade(s) por item produzido.
                </div>

                <div id="usageBatchConfig" class="usage-config hidden text-sm text-gray-600 flex items-center flex-wrap">
                    Usar <input id="usageBatchQty" type="number" value="1" min="1" class="w-16 border border-gray-300 rounded px-2 py-1 mx-2 text-center focus:outline-none focus:ring-1 focus:ring-primary"> unidade(s) a cada <input id="usageBatchLimit" type="number" value="5" min="1" class="w-16 border border-gray-300 rounded px-2 py-1 mx-2 text-center focus:outline-none focus:ring-1 focus:ring-primary"> itens.
                </div>

                <div id="usageOrderConfig" class="usage-config hidden text-sm text-gray-600 flex items-center flex-wrap">
                    Usar <input id="usageOrderQty" type="number" value="1" min="1" class="w-16 border border-gray-300 rounded px-2 py-1 mx-2 text-center focus:outline-none focus:ring-1 focus:ring-primary"> unidade(s) por pedido total.
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Custo Unitário (R$)</label>
                    <input id="inventoryCost" type="number" step="0.01" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="0.00">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Quantidade</label>
                    <input id="inventoryQuantity" type="number" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="0">
                </div>
            </div>

            <div id="inventorySchoolContainer" class="space-y-2 hidden">
                <label class="text-sm font-medium text-gray-700">Escola/Revendedor</label>
                <select id="inventorySchool" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">Selecione...</option>
                </select>
            </div>

            <div id="inventoryImageContainer" class="space-y-2 hidden">
                <label class="text-sm font-medium text-gray-700">Imagem da Estampa</label>
                <div class="flex items-center gap-4">
                    <input id="inventoryImage" type="file" accept="image/*" onchange="previewImage(this)" class="flex w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary">
                    <img id="inventoryImagePreview" src="" alt="Preview" class="h-10 w-10 object-cover rounded border hidden">
                </div>
                <p class="text-xs text-muted-foreground">A imagem será salva no sistema.</p>
            </div>

            <div class="flex justify-end gap-2 pt-4">
                <button onclick="closeInventoryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Cancelar</button>
                <button id="saveInventoryBtn" onclick="saveInventory()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Compra -->
    <div id="purchaseModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-primary">Registrar Compra</h2>
            
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Fornecedor</label>
                <input id="purchaseSupplier" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Nome do Fornecedor">
            </div>

            <div class="p-4 bg-gray-50 rounded-md border border-gray-200 space-y-4">
                <h3 class="text-sm font-semibold">Adicionar Item</h3>
                <div class="grid grid-cols-12 gap-2 items-end">
                    <div class="col-span-5 space-y-1">
                        <label class="text-xs font-medium">Item</label>
                        <select id="purchaseItemSelect" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-xs font-medium">Qtd</label>
                        <input id="purchaseItemQty" type="number" class="flex h-9 w-full rounded-md border border-gray-300 px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0">
                    </div>
                    <div class="col-span-3 space-y-1">
                        <label class="text-xs font-medium">Valor Total Pago (R$)</label>
                        <input id="purchaseItemTotal" type="number" step="0.01" class="flex h-9 w-full rounded-md border border-gray-300 px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
                    </div>
                    <div class="col-span-2">
                        <button onclick="addPurchaseItem()" class="w-full h-9 bg-secondary text-secondary-foreground hover:bg-secondary/80 rounded-md text-xs font-medium border border-gray-300">Adicionar</button>
                    </div>
                </div>
            </div>

            <div class="border rounded-md overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-muted-foreground font-medium">
                        <tr><th class="px-4 py-2">Item</th><th class="px-4 py-2">Qtd</th><th class="px-4 py-2">Total</th><th class="px-4 py-2 text-right">Ação</th></tr>
                    </thead>
                    <tbody id="purchaseItemsList" class="divide-y">
                        <!-- Itens adicionados -->
                    </tbody>
                </table>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-2">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Frete Total (R$)</label>
                    <input id="purchaseShipping" type="number" step="0.01" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
                </div>
                <div class="flex flex-col justify-end items-end">
                    <span class="text-sm text-muted-foreground">Total da Compra</span>
                    <span id="purchaseTotalDisplay" class="text-2xl font-bold text-primary">R$ 0,00</span>
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t">
                <button onclick="closePurchaseModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="finalizePurchaseBtn" onclick="finalizePurchase()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">Finalizar Compra</button>
            </div>
        </div>
    </div>

    <!-- Modal de Movimentações -->
    <div id="movementsModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Extrato de Movimentações</h2>
                <button onclick="closeMovementsModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <div class="border rounded-md overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-muted-foreground font-medium">
                        <tr>
                            <th class="px-4 py-3">Data</th>
                            <th class="px-4 py-3">Tipo</th>
                            <th class="px-4 py-3">Item</th>
                            <th class="px-4 py-3">Qtd</th>
                            <th class="px-4 py-3">Valor Unit.</th>
                            <th class="px-4 py-3">Origem/Destino</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTableBody" class="divide-y">
                        <tr><td colspan="6" class="p-4 text-center text-muted-foreground">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Visualização de Imagem (Zoom) -->
    <div id="imageModal" class="fixed inset-0 z-[150] hidden items-center justify-center bg-black/80 backdrop-blur-sm" onclick="closeImageModal()">
        <div class="relative max-w-4xl max-h-[90vh] p-4" onclick="event.stopPropagation()">
            <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white hover:text-gray-300 transition-colors">
                <i data-lucide="x" class="h-8 w-8"></i>
            </button>
            <img id="fullSizeImage" src="" alt="Visualização Ampliada" referrerpolicy="no-referrer" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl object-contain bg-black">
        </div>
    </div>

    <!-- Modal de Produto -->
    <div id="productModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 id="productModalTitle" class="text-xl font-bold text-primary">Novo Produto</h2>
                <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna Esquerda: Dados Básicos -->
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Nome do Produto</label>
                        <input id="productName" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ex: Camiseta Polo Escolar">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Estampa Associada (Estoque)</label>
                        <select id="productPrint" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione uma estampa...</option>
                        </select>
                        <p class="text-xs text-muted-foreground">Define a imagem da estampa e baixa o estoque ao produzir.</p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Escola/Revendedor Associado</label>
                        <select id="productPartner" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Produto genérico (sem repasse)</option>
                        </select>
                        <p class="text-xs text-muted-foreground">Define a qual parceiro este produto pertence para filtros e repasses.</p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Imagens de Referência</label>
                        <input id="productImages" type="file" multiple accept="image/*" class="flex w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium">
                        <div id="productImagesPreview" class="flex gap-2 overflow-x-auto py-2 h-24"></div>
                    </div>
                </div>

                <!-- Coluna Direita: Variações e Preços -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-700">Categorias de Malha & Preços</label>
                        <button onclick="addProductCategoryRow()" class="text-xs bg-secondary hover:bg-gray-200 px-2 py-1 rounded border flex items-center gap-1">
                            <i data-lucide="plus" class="h-3 w-3"></i> Add Categoria
                        </button>
                    </div>
                    
                    <div class="border rounded-md overflow-hidden bg-gray-50">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-100 font-medium text-gray-600 border-b">
                                <tr>
                                    <th class="p-2">Malha/Categoria</th>
                                    <th class="p-2" title="Preço para o Cliente Final">Venda (R$)</th>
                                    <th class="p-2" title="Custo de Produção">Prod. (R$)</th>
                                    <th class="p-2" title="Repasse Escola/Revendedor">Escola (R$)</th>
                                    <th class="p-2" title="Lucro Administrativo">Adm (R$)</th>
                                    <th class="p-2 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="productPricingBody" class="divide-y bg-white">
                                <!-- Linhas dinâmicas -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-muted-foreground">* Defina os valores manualmente para cada campo.</p>
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t mt-4">
                <button onclick="closeProductModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="saveProductBtn" onclick="saveProduct()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90">Salvar Produto</button>
            </div>
        </div>
    </div>

    <!-- Modal de Orçamento/Pedido -->
    <div id="orderModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 id="orderModalTitle" class="text-xl font-bold text-primary">Novo Orçamento</h2>
                <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                    <input id="orderClientName" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Nome do Cliente">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Telefone / WhatsApp</label>
                    <input id="orderClientPhone" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="(00) 00000-0000">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Revendedor / Escola</label>
                    <select id="orderPartner" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div id="orderStudentContainer" class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Nome do Estudante (Opcional)</label>
                    <input id="orderStudentName" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Nome do Aluno">
                </div>
                <div class="col-span-1 md:col-span-2 space-y-2">
                    <label class="text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="orderObservation" class="flex w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" rows="2" placeholder="Detalhes especiais do pedido..."></textarea>
                </div>
            </div>

            <div class="p-4 bg-gray-50 rounded-md border border-gray-200 space-y-4">
                <h3 class="text-sm font-semibold">Adicionar Produtos</h3>
                <div class="grid grid-cols-12 gap-2 items-end">
                    <div class="col-span-4 space-y-1">
                        <label class="text-xs font-medium">Produto</label>
                        <select id="orderProductSelect" onchange="onOrderProductChange()" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-span-3 space-y-1">
                        <label class="text-xs font-medium">Categoria</label>
                        <select id="orderProductCategory" onchange="onOrderCategoryChange()" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-xs font-medium">Tamanho/Var.</label>
                        <select id="orderProductSize" class="flex h-9 w-full rounded-md border border-gray-300 bg-white px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-span-1 space-y-1">
                        <label class="text-xs font-medium">Qtd</label>
                        <input id="orderProductQty" type="number" value="1" min="1" class="flex h-9 w-full rounded-md border border-gray-300 px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-xs font-medium">Valor (R$)</label>
                        <input id="orderProductPrice" type="number" step="0.01" class="flex h-9 w-full rounded-md border border-gray-300 px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="addOrderProduct()" class="w-full md:w-auto px-4 h-9 bg-secondary text-secondary-foreground hover:bg-secondary/80 rounded-md text-xs font-medium border border-gray-300">Adicionar Item</button>
                </div>
            </div>

            <div class="border rounded-md overflow-hidden max-h-40 overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-muted-foreground font-medium sticky top-0">
                        <tr><th class="px-4 py-2">Produto</th><th class="px-4 py-2">Cat. / Tam.</th><th class="px-4 py-2">Qtd</th><th class="px-4 py-2">Total</th><th class="px-4 py-2 text-right">Ação</th></tr>
                    </thead>
                    <tbody id="orderItemsList" class="divide-y"></tbody>
                </table>
            </div>

            <div class="flex justify-between items-center pt-2 border-t">
                <div class="text-lg font-bold">Total: <span id="orderTotalDisplay" class="text-primary">R$ 0,00</span></div>
                <div class="flex gap-2">
                    <button onclick="closeOrderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="saveOrderBtn" onclick="saveOrder()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90">Salvar Orçamento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Orçamento -->
    <div id="confirmOrderModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-md space-y-4 shadow-xl border border-gray-200">
            <h2 class="text-xl font-bold text-primary">Aprovar Orçamento</h2>
            <p class="text-sm text-gray-600">Ao aprovar, o cliente será cadastrado e o pedido irá para "Pendente".</p>
            
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Status do Pagamento</label>
                <select id="confirmPaymentStatus" onchange="toggleSinalInput()" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="Pendente">Pendente</option>
                    <option value="Pago Parcial">Pago Parcial (Sinal)</option>
                    <option value="Pago Total">Pago Total</option>
                </select>
            </div>

            <div id="confirmSinalContainer" class="space-y-2 hidden">
                <label class="text-sm font-medium text-gray-700">Valor do Sinal (R$)</label>
                <input id="confirmSinalValue" type="number" step="0.01" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Quem irá produzir?</label>
                <select id="confirmProducer" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">Selecione...</option>
                </select>
            </div>

            <div class="flex justify-end gap-2 pt-4">
                <button onclick="document.getElementById('confirmOrderModal').classList.add('hidden'); document.getElementById('confirmOrderModal').classList.remove('flex');" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btnConfirmOrderAction" onclick="confirmOrderAction()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">Confirmar e Produzir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Erro de Produção -->
    <div id="errorModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-xl font-bold text-destructive">Reportar Erro de Produção</h2>
                <button onclick="closeErrorModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            
            <p class="text-sm text-gray-600">
                Registre os itens que foram perdidos durante a produção. Isso <span class="font-bold">não</span> reverterá o uso de materiais do estoque, mas marcará a perda para fins de relatório.
            </p>

            <div class="border rounded-md overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-muted-foreground font-medium">
                        <tr>
                            <th class="px-4 py-2">Produto</th>
                            <th class="px-4 py-2">Qtd no Pedido</th>
                            <th class="px-4 py-2 w-32">Qtd com Erro</th>
                        </tr>
                    </thead>
                    <tbody id="errorItemsList" class="divide-y bg-white">
                        <!-- Itens do pedido carregados via JS -->
                    </tbody>
                </table>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Motivo do Erro</label>
                <textarea id="errorReason" class="flex w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-destructive" rows="2" placeholder="Ex: Estampa torta, costura defeituosa, mancha no tecido..."></textarea>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t">
                <button onclick="closeErrorModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="saveErrorBtn" onclick="saveProductionError()" class="px-4 py-2 text-sm font-medium text-white bg-destructive rounded-md hover:bg-destructive/90">Registrar Perda</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edição de Erro -->
    <div id="editErrorModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg space-y-4 shadow-xl border border-gray-200">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-xl font-bold text-primary">Editar Registro de Erro</h2>
                <button onclick="closeEditErrorModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            
            <div class="bg-gray-50 p-3 rounded border">
                <div id="editErrorProductInfo" class="font-medium"></div>
                <div id="editErrorOrderInfo" class="text-xs text-gray-500"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Qtd. com Erro</label>
                    <input id="editErrorQty" type="number" min="1" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Motivo do Erro</label>
                <textarea id="editErrorReason" class="flex w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" rows="2"></textarea>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t">
                <button onclick="closeEditErrorModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="saveEditedErrorBtn" onclick="saveEditedError()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Modal de Relatório de Materiais -->
    <div id="materialReportModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-xl font-bold text-primary">Relatório de Produção e Compras</h2>
                <button onclick="document.getElementById('materialReportModal').classList.add('hidden'); document.getElementById('materialReportModal').classList.remove('flex');" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna: Necessário -->
                <div class="space-y-2">
                    <h3 class="font-semibold text-gray-700 flex items-center gap-2"><i data-lucide="list-todo" class="h-4 w-4"></i> Necessário para Produção</h3>
                    <div class="border rounded-md overflow-hidden bg-gray-50">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-muted-foreground font-medium"><tr><th class="p-2">Item</th><th class="p-2 text-right">Qtd Total</th></tr></thead>
                            <tbody id="reportNeedsBody" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Coluna: Compras -->
                <div class="space-y-2">
                    <h3 class="font-semibold text-red-600 flex items-center gap-2"><i data-lucide="shopping-cart" class="h-4 w-4"></i> Falta no Estoque (Comprar)</h3>
                    <div class="border rounded-md overflow-hidden bg-red-50">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-red-100 text-red-800 font-medium"><tr><th class="p-2">Item</th><th class="p-2 text-right">Falta</th><th class="p-2 text-right">Estoque Atual</th></tr></thead>
                            <tbody id="reportMissingBody" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="text-xs text-gray-500 mt-4">
                * O cálculo de "Falta" considera o estoque atual menos os itens reservados para outros pedidos em andamento (Pendente/Produção) não selecionados.
            </div>
            
            <div class="flex justify-end pt-4 border-t">
                <button onclick="window.print()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-2"><i data-lucide="printer" class="h-4 w-4"></i> Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico de Pagamentos -->
    <div id="paymentHistoryModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl space-y-4 shadow-xl border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Histórico de Repasses Realizados</h2>
                <button onclick="document.getElementById('paymentHistoryModal').classList.add('hidden'); document.getElementById('paymentHistoryModal').classList.remove('flex');" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            
            <div class="border rounded-md overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-muted-foreground font-medium">
                        <tr>
                            <th class="px-4 py-3">Data Pagamento</th>
                            <th class="px-4 py-3">Beneficiário</th>
                            <th class="px-4 py-3">Tipo</th>
                            <th class="px-4 py-3">Ref. Pedido</th>
                            <th class="px-4 py-3 text-right">Valor Pago</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryBody" class="divide-y">
                        <tr><td colspan="5" class="p-4 text-center text-muted-foreground">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWZEZskuEMIby9dr5iWfH2G3nsXj14gr4",
            authDomain: "camisetasran.firebaseapp.com",
            projectId: "camisetasran",
            storageBucket: "camisetasran.firebasestorage.app",
            messagingSenderId: "983902425471",
            appId: "1:983902425471:web:c072c921574fd2415d8a4a",
            measurementId: "G-6FJGXVCYV6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Configuração do Upload via Apps Script ---
        // COLE AQUI A URL QUE VOCÊ COPIOU NO PASSO 1
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkgUduzLRYSABf5bY5YZrRCmWr8yFOeS0CIW4JMS1tC-MS4GqWaNUBXp8PvOBlnhSqHg/exec';

        let partners = [];
        let clients = [];
        let inventory = [];
        let currentPartnerId = null;
        let currentClientId = null;
        let currentInventoryId = null;
        let currentProductId = null;
        let purchaseList = [];
        let orderList = []; // Itens do pedido atual
        let currentOrderId = null;
        let currentProductionStatus = 'Orçamento';
        let orderToConfirmId = null;
        let selectedOrderIds = new Set();
        let currentErrorId = null;
        let errorToReportId = null;
        let productionErrors = [];
        window.allOrders = []; // Global para acesso no dashboard

        // Função para buscar parceiros
        async function fetchPartners() {
            try {
                const querySnapshot = await getDocs(collection(db, "partners"));
                partners = [];
                querySnapshot.forEach((doc) => {
                    partners.push({ id: doc.id, ...doc.data() });
                });
                renderPartners();
                populateProductFilter(); // Popula o filtro de produtos
                fetchClients(); // Busca clientes depois de ter os parceiros para mapear nomes
                fetchInventory();
                fetchProducts();
                fetchOrders();
                fetchErrors();
                // fetchTransfers será chamado ao clicar na aba ou manualmente se necessário, mas vamos popular o filtro de parceiros dele
                checkAutoArchive(); // Verifica arquivamento automático ao iniciar
            } catch (error) {
                console.error("Erro ao buscar parceiros:", error);
                document.getElementById('partners-table-body').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            }
        }

        // Função para buscar erros de produção
        async function fetchErrors() {
            try {
                const querySnapshot = await getDocs(collection(db, "productionErrors"));
                productionErrors = [];
                querySnapshot.forEach((doc) => {
                    productionErrors.push({ id: doc.id, ...doc.data() });
                });
                renderErrors();
            } catch (error) {
                console.error("Erro ao buscar erros de produção:", error);
                document.getElementById('errors-table-body').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            }
        }

        function renderErrors() {
            const tbody = document.getElementById('errors-table-body');
            if (!tbody) return;

            // Ordenar por data mais recente
            productionErrors.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (productionErrors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-muted-foreground">Nenhum erro de produção registrado.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            productionErrors.forEach(error => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3">${new Date(error.createdAt).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <div class="font-medium">#${error.orderId.slice(-4)}</div>
                        <div class="text-xs text-muted-foreground">${error.clientName}</div>
                    </td>
                    <td>
                        <div class="font-medium">${error.productName}</div>
                        <div class="text-xs text-muted-foreground">${error.category} / ${error.size}</div>
                    </td>
                    <td class="font-bold text-destructive">${error.errorQty}</td>
                    <td class="text-sm text-muted-foreground max-w-xs truncate" title="${error.reason}">${error.reason}</td>
                    <td class="text-right">
                        <div class="flex justify-end gap-1">
                            <button onclick="window.openEditErrorModal('${error.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-primary" title="Editar"><i data-lucide="pencil" class="h-4 w-4"></i></button>
                            <button onclick="window.deleteProductionError('${error.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-red-500" title="Excluir"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // Popula o filtro de parceiros na aba de produtos
        function populateProductFilter() {
            const select = document.getElementById('productFilterPartner');
            const transferSelect = document.getElementById('transferFilterPartner');
            
            if(select) select.innerHTML = '<option value="">Todas as Escolas</option>';
            if(transferSelect) transferSelect.innerHTML = '<option value="">Todos</option>';

            partners.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nickname || p.name;
                
                if(select) select.appendChild(option);
                
                if(transferSelect) {
                    const opt2 = option.cloneNode(true);
                    transferSelect.appendChild(opt2);
                }
            });
        }

        // Função para renderizar a tabela
        function renderPartners() {
            const tbody = document.getElementById('partners-table-body');
            if (!tbody) return;
            
            if (partners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-muted-foreground">Nenhum parceiro encontrado.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            partners.forEach(partner => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 font-medium">${partner.name || ''}</td>
                    <td>${partner.nickname || ''}</td>
                    <td><span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">${partner.category || 'Escola'}</span></td>
                    <td>${partner.pix || '-'}</td>
                    <td><span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Ativo</span></td>
                    <td class="text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="window.openPartnerModal('${partner.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-primary" title="Editar"><i data-lucide="pencil" class="h-4 w-4"></i></button>
                            <button onclick="window.deletePartner('${partner.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-red-500" title="Excluir"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // Função para buscar clientes
        async function fetchClients() {
            try {
                const querySnapshot = await getDocs(collection(db, "clients"));
                clients = [];
                querySnapshot.forEach((doc) => {
                    clients.push({ id: doc.id, ...doc.data() });
                });
                renderClients();
            } catch (error) {
                console.error("Erro ao buscar clientes:", error);
                document.getElementById('clients-table-body').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            }
        }

        // Função para renderizar tabela de clientes
        function renderClients() {
            const tbody = document.getElementById('clients-table-body');
            if (!tbody) return;
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-muted-foreground">Nenhum cliente encontrado.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            clients.forEach(client => {
                const partner = partners.find(p => p.id === client.partnerId);
                const partnerName = partner ? (partner.nickname || partner.name) : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 font-medium">${client.name || ''}</td>
                    <td>${client.phone || ''}</td>
                    <td>${partnerName}</td>
                    <td>${client.studentName || '-'}</td>
                    <td class="text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="window.openClientModal('${client.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-primary" title="Editar"><i data-lucide="pencil" class="h-4 w-4"></i></button>
                            <button onclick="window.deleteClient('${client.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-red-500" title="Excluir"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // Função para buscar estoque
        async function fetchInventory() {
            try {
                const querySnapshot = await getDocs(collection(db, "inventory"));
                inventory = [];
                querySnapshot.forEach((doc) => {
                    inventory.push({ id: doc.id, ...doc.data() });
                });
                renderInventory();
            } catch (error) {
                console.error("Erro ao buscar estoque:", error);
                document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="6" class="py-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            }
        }

        // Função para renderizar tabela de estoque
        function renderInventory() {
            const tbody = document.getElementById('inventory-table-body');
            if (!tbody) return;
            
            if (inventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-muted-foreground">Nenhum item no estoque.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // Filtros de Estoque
            const filterType = document.getElementById('inventoryFilterType')?.value;

            const filteredInventory = inventory.filter(i => {
                // Filtro de Tipo (Case insensitive para compatibilidade com itens antigos)
                if (filterType && String(i.type || '').trim().toLowerCase() !== filterType.trim().toLowerCase()) {
                    return false;
                }
                return true;
            });

            filteredInventory.forEach(item => {
                const isPrint = item.type === 'Estampa';
                const isInsumo = item.type === 'Insumo';
                const displayUrl = getDisplayUrl(item.image);
                const imageHtml = isPrint && item.image ? 
                    `<img src="${displayUrl}" onclick="openImageModal('${item.image}')" referrerpolicy="no-referrer" class="h-8 w-8 object-cover rounded border cursor-pointer hover:opacity-80 transition-opacity" alt="Estampa" title="Clique para ampliar">` : 
                    '<div class="h-8 w-8 bg-gray-100 rounded border flex items-center justify-center"><i data-lucide="package" class="h-4 w-4 text-gray-400"></i></div>';
                
                let typeBadgeClass = 'bg-blue-100 text-blue-800'; // Malha (Default)
                if (isPrint) typeBadgeClass = 'bg-purple-100 text-purple-800';
                if (isInsumo) typeBadgeClass = 'bg-orange-100 text-orange-800';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3">${imageHtml}</td>
                    <td class="font-medium">${item.name || ''}</td>
                    <td>
                        <span class="px-2 py-1 rounded-full text-xs ${typeBadgeClass}">${item.type}</span>
                        ${!isPrint && item.category ? `<span class="text-xs text-gray-500 ml-2">(${item.category})</span>` : ''}
                    </td>
                    <td>R$ ${parseFloat(item.cost || 0).toFixed(2)}</td>
                    <td>${item.quantity || 0}</td>
                    <td class="text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="window.openInventoryModal('${item.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-primary" title="Editar"><i data-lucide="pencil" class="h-4 w-4"></i></button>
                            <button onclick="window.deleteInventory('${item.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-red-500" title="Excluir"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // Função para buscar produtos
        async function fetchProducts() {
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                const products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(products);
            } catch (error) {
                console.error("Erro ao buscar produtos:", error);
            }
        }

        // Renderizar tabela de produtos
        function renderProducts(products) {
            const tbody = document.getElementById('products-table-body');
            if (!tbody) return;
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-muted-foreground">Nenhum produto cadastrado.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // Filtro de Produtos por Parceiro
            const filterPartner = document.getElementById('productFilterPartner')?.value;
            const filteredProducts = filterPartner ? products.filter(p => p.partnerId === filterPartner) : products;

            filteredProducts.forEach(prod => {
                // Pega a primeira categoria para exibir preço base ou range
                const prices = prod.pricing || [];
                const priceDisplay = prices.length > 0 ? `R$ ${parseFloat(prices[0].salePrice).toFixed(2)}` : '-';
                const categoriesDisplay = prices.map(p => p.category).join(', ');

                const partner = partners.find(p => p.id === prod.partnerId);
                const partnerName = partner ? (partner.nickname || partner.name) : '<span class="text-gray-400">Genérico</span>';

                // Lógica para imagem do produto
                let productImageUrl = null;
                let useBlackBackground = false;
                if (prod.images && prod.images.length > 0) {
                    productImageUrl = prod.images[0]; // Usa a primeira imagem de referência
                } else if (prod.printId) {
                    const printItem = inventory.find(i => i.id === prod.printId);
                    if (printItem && printItem.image) {
                        productImageUrl = printItem.image; // Usa a imagem da estampa
                        useBlackBackground = true; // Aplica fundo preto para a estampa
                    }
                }

                let imageHtml = '<div class="h-10 w-10 bg-gray-100 rounded border flex items-center justify-center"><i data-lucide="shirt" class="h-5 w-5 text-gray-400"></i></div>';
                if (productImageUrl) {
                    const displayUrl = getDisplayUrl(productImageUrl);
                    const bgClass = useBlackBackground ? 'bg-black' : 'bg-white';
                    imageHtml = `<img src="${displayUrl}" referrerpolicy="no-referrer" class="h-10 w-10 object-contain rounded border ${bgClass} p-1">`;
                }

                const status = prod.status || 'Ativo';
                const statusBadge = status === 'Ativo' 
                    ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Ativo</span>' 
                    : '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">Inativo</span>';
                
                const opacityClass = status === 'Inativo' ? 'opacity-60' : '';

                const tr = document.createElement('tr');
                tr.className = opacityClass;
                tr.innerHTML = `
                    <td class="py-3">${imageHtml}</td>
                    <td class="py-3 font-medium">${prod.name}</td>
                    <td class="text-sm text-gray-600">${partnerName}</td>
                    <td class="text-sm text-gray-600">${categoriesDisplay || '-'}</td>
                    <td>${priceDisplay}</td>
                    <td>${statusBadge}</td>
                    <td class="text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="window.toggleProductStatus('${prod.id}', '${status}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors ${status === 'Ativo' ? 'text-orange-500' : 'text-green-600'}" title="${status === 'Ativo' ? 'Inativar' : 'Ativar'}"><i data-lucide="${status === 'Ativo' ? 'power-off' : 'power'}" class="h-4 w-4"></i></button>
                            <button onclick="window.openProductModal('${prod.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-primary" title="Editar"><i data-lucide="pencil" class="h-4 w-4"></i></button>
                            <button onclick="window.deleteProduct('${prod.id}')" class="p-2 hover:bg-gray-100 rounded-md transition-colors text-red-500" title="Excluir"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // Funções globais para acesso via HTML onclick
        window.openPartnerModal = (id = null) => {
            const modal = document.getElementById('partnerModal');
            const title = document.getElementById('modalTitle');
            const nameInput = document.getElementById('partnerName');
            const nicknameInput = document.getElementById('partnerNickname');
            const categoryInput = document.getElementById('partnerCategory');
            const pixInput = document.getElementById('partnerPix');

            // Resetar estado do botão ao abrir
            const saveBtn = document.getElementById('savePartnerBtn');
            saveBtn.textContent = 'Salvar';
            saveBtn.disabled = false;

            currentPartnerId = id;

            if (id) {
                const partner = partners.find(p => p.id === id);
                if (partner) {
                    title.textContent = 'Editar Parceiro';
                    nameInput.value = partner.name || '';
                    nicknameInput.value = partner.nickname || '';
                    categoryInput.value = partner.category || 'Escola';
                    pixInput.value = partner.pix || '';
                }
            } else {
                title.textContent = 'Novo Parceiro';
                nameInput.value = '';
                nicknameInput.value = '';
                categoryInput.value = 'Escola';
                pixInput.value = '';
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closePartnerModal = () => {
            const modal = document.getElementById('partnerModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.savePartner = async () => {
            const name = document.getElementById('partnerName').value;
            const nickname = document.getElementById('partnerNickname').value;
            const category = document.getElementById('partnerCategory').value;
            const pix = document.getElementById('partnerPix').value;

            if (!name || !nickname) {
                alert('Nome e Apelido são obrigatórios');
                return;
            }

            const saveBtn = document.getElementById('savePartnerBtn');
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;

            try {
                if (currentPartnerId) {
                    await updateDoc(doc(db, "partners", currentPartnerId), {
                        name, nickname, category, pix
                    });
                } else {
                    await addDoc(collection(db, "partners"), {
                        name, nickname, category, pix, status: 'Ativo'
                    });
                }
                window.closePartnerModal();
                fetchPartners(); // Atualiza em background para não travar a UI
            } catch (e) {
                console.error("DETAILED FIREBASE ERROR (Partner):", e);
                alert("Erro ao salvar parceiro: " + e.message + "\n\nVerifique o console do navegador (F12) para mais detalhes.");
            } finally {
                saveBtn.textContent = 'Salvar';
                saveBtn.disabled = false;
            }
        }

        window.deletePartner = async (id) => {
            if (confirm('Tem certeza que deseja excluir este parceiro?')) {
                try {
                    await deleteDoc(doc(db, "partners", id));
                    await fetchPartners();
                } catch (e) {
                    console.error("Error deleting partner: ", e);
                    alert("Erro ao excluir parceiro");
                }
            }
        }

        // Funções para Clientes
        window.openClientModal = (id = null) => {
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('clientModalTitle');
            const nameInput = document.getElementById('clientName');
            const phoneInput = document.getElementById('clientPhone');
            const partnerSelect = document.getElementById('clientPartner');
            const studentInput = document.getElementById('clientStudent');

            // Resetar estado do botão ao abrir
            const saveBtn = document.getElementById('saveClientBtn');
            saveBtn.textContent = 'Salvar';
            saveBtn.disabled = false;

            // Popular select de parceiros
            partnerSelect.innerHTML = '<option value="">Selecione um parceiro...</option>';
            partners.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nickname || p.name;
                partnerSelect.appendChild(option);
            });

            currentClientId = id;

            if (id) {
                const client = clients.find(c => c.id === id);
                if (client) {
                    title.textContent = 'Editar Cliente';
                    nameInput.value = client.name || '';
                    phoneInput.value = client.phone || '';
                    partnerSelect.value = client.partnerId || '';
                    studentInput.value = client.studentName || '';
                }
            } else {
                title.textContent = 'Novo Cliente';
                nameInput.value = '';
                phoneInput.value = '';
                partnerSelect.value = '';
                studentInput.value = '';
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeClientModal = () => {
            const modal = document.getElementById('clientModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.saveClient = async () => {
            const name = document.getElementById('clientName').value;
            const phone = document.getElementById('clientPhone').value;
            const partnerId = document.getElementById('clientPartner').value;
            const studentName = document.getElementById('clientStudent').value;

            if (!name) {
                alert('Nome do cliente é obrigatório');
                return;
            }

            const saveBtn = document.getElementById('saveClientBtn');
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;

            try {
                const clientData = {
                    name, phone, partnerId, studentName
                };

                if (currentClientId) {
                    await updateDoc(doc(db, "clients", currentClientId), clientData);
                } else {
                    await addDoc(collection(db, "clients"), {
                        ...clientData,
                        lastPurchase: new Date().toISOString()
                    });
                }
                window.closeClientModal();
                fetchClients(); // Atualiza em background para não travar a UI
            } catch (e) {
                console.error("DETAILED FIREBASE ERROR (Client):", e);
                alert("Erro ao salvar cliente: " + e.message + "\n\nVerifique o console do navegador (F12) para mais detalhes.");
            } finally {
                saveBtn.textContent = 'Salvar';
                saveBtn.disabled = false;
            }
        }

        window.deleteClient = async (id) => {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                try {
                    await deleteDoc(doc(db, "clients", id));
                    await fetchClients();
                } catch (e) {
                    console.error("Error deleting client: ", e);
                    alert("Erro ao excluir cliente");
                }
            }
        }

        window.previewImage = (input) => {
            const preview = document.getElementById('inventoryImagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.classList.add('hidden');
            }
        }

        // Funções para Estoque
        window.openInventoryModal = (id = null) => {
            const modal = document.getElementById('inventoryModal');
            const title = document.getElementById('inventoryModalTitle');
            const typeInput = document.getElementById('inventoryType');
            const nameInput = document.getElementById('inventoryName');
            const costInput = document.getElementById('inventoryCost');
            const qtyInput = document.getElementById('inventoryQuantity');
            const categorySelect = document.getElementById('inventoryCategory');
            const schoolSelect = document.getElementById('inventorySchool');
            const imageInput = document.getElementById('inventoryImage');
            const imagePreview = document.getElementById('inventoryImagePreview');
            
            const usageTypeSelect = document.getElementById('inventoryUsageType');
            const usageUnitQty = document.getElementById('usageUnitQty');
            const usageBatchQty = document.getElementById('usageBatchQty');
            const usageBatchLimit = document.getElementById('usageBatchLimit');
            const usageOrderQty = document.getElementById('usageOrderQty');

            // Resetar botão
            const saveBtn = document.getElementById('saveInventoryBtn');
            saveBtn.textContent = 'Salvar';
            saveBtn.disabled = false;

            // Popular select de escolas
            schoolSelect.innerHTML = '<option value="">Selecione...</option>';
            partners.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nickname || p.name;
                schoolSelect.appendChild(option);
            });

            // Popular select de categorias (baseado nos itens existentes)
            const uniqueCategories = [...new Set(inventory.map(i => i.category).filter(c => c))].sort();
            categorySelect.innerHTML = '<option value="">Selecione...</option>';
            uniqueCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });

            currentInventoryId = id;

            if (id) {
                const item = inventory.find(i => i.id === id);
                if (item) {
                    title.textContent = 'Editar Item';
                    typeInput.value = item.type || 'Malha';
                    nameInput.value = item.name || '';
                    categorySelect.value = item.category || '';
                    costInput.value = item.cost || '';
                    qtyInput.value = item.quantity || '';
                    schoolSelect.value = item.partnerId || '';
                    // imageInput.value não pode ser definido programaticamente por segurança
                    if (item.image) {
                        imagePreview.src = item.image;
                        imagePreview.classList.remove('hidden');
                    } else {
                        imagePreview.classList.add('hidden');
                    }

                    // Carregar regras de uso se existirem
                    if (item.usageRule) {
                        usageTypeSelect.value = item.usageRule.type || 'unit';
                        if (item.usageRule.type === 'unit') usageUnitQty.value = item.usageRule.qty || 1;
                        if (item.usageRule.type === 'batch') { usageBatchQty.value = item.usageRule.qty || 1; usageBatchLimit.value = item.usageRule.limit || 5; }
                        if (item.usageRule.type === 'order') usageOrderQty.value = item.usageRule.qty || 1;
                    } else {
                        usageTypeSelect.value = 'unit';
                    }
                }
            } else {
                title.textContent = 'Novo Item';
                typeInput.value = 'Malha';
                nameInput.value = '';
                categorySelect.value = '';
                costInput.value = '';
                qtyInput.value = '';
                schoolSelect.value = '';
                imageInput.value = '';
                imagePreview.classList.add('hidden');
                usageTypeSelect.value = 'unit';
                usageUnitQty.value = '1';
                usageBatchQty.value = '1';
                usageBatchLimit.value = '5';
                usageOrderQty.value = '1';
            }
            
            window.toggleInventoryFields(); // Atualiza visibilidade do campo de imagem
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons(); // Atualiza ícones (para o botão de +)
        }

        window.closeInventoryModal = () => {
            const modal = document.getElementById('inventoryModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.toggleInventoryFields = () => {
            const type = document.getElementById('inventoryType').value;
            const imageContainer = document.getElementById('inventoryImageContainer');
            const schoolContainer = document.getElementById('inventorySchoolContainer');
            const categoryContainer = document.getElementById('inventoryCategoryContainer');
            const usageContainer = document.getElementById('inventoryUsageContainer');
            
            if (type === 'Estampa') {
                imageContainer.classList.remove('hidden');
                schoolContainer.classList.remove('hidden');
                categoryContainer.classList.add('hidden');
                usageContainer.classList.add('hidden');
            } else if (type === 'Insumo') {
                imageContainer.classList.add('hidden');
                schoolContainer.classList.add('hidden');
                categoryContainer.classList.remove('hidden');
                usageContainer.classList.remove('hidden');
                window.toggleUsageFields();
            } else { // Malha
                imageContainer.classList.add('hidden');
                schoolContainer.classList.add('hidden');
                categoryContainer.classList.remove('hidden');
                usageContainer.classList.add('hidden');
            }
        }

        window.toggleUsageFields = () => {
            const type = document.getElementById('inventoryUsageType').value;
            document.querySelectorAll('.usage-config').forEach(el => el.classList.add('hidden'));
            if (type === 'unit') document.getElementById('usageUnitConfig').classList.remove('hidden');
            if (type === 'batch') document.getElementById('usageBatchConfig').classList.remove('hidden');
            if (type === 'order') document.getElementById('usageOrderConfig').classList.remove('hidden');
        }

        window.createNewCategory = () => {
            const newCat = prompt("Digite o nome da nova categoria:");
            if (newCat && newCat.trim() !== "") {
                const select = document.getElementById('inventoryCategory');
                const option = document.createElement('option');
                option.value = newCat.trim();
                option.textContent = newCat.trim();
                select.appendChild(option);
                select.value = newCat.trim();
            }
        }

        // Função auxiliar para upload no Google Drive via Script
        async function uploadToDrive(file) {
            if (APPS_SCRIPT_URL.includes('SEU_CODIGO_AQUI')) {
                alert("Configure a URL do Google Apps Script no código (linha ~586)!");
                throw new Error("Script URL not configured");
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        const payload = {
                            name: Date.now() + '_' + file.name,
                            type: file.type,
                            image: reader.result // Base64 completo
                        };

                        const response = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        if (data.result === 'success') {
                            resolve(data.url);
                        } else {
                            throw new Error(data.error || 'Erro desconhecido no script');
                        }
                    } catch (err) {
                        console.error(err);
                        reject(err);
                    }
                };
                reader.onerror = error => reject(error);
            });
        }

        window.saveInventory = async () => {
            const type = document.getElementById('inventoryType').value;
            const name = document.getElementById('inventoryName').value;
            const cost = document.getElementById('inventoryCost').value;
            const quantity = document.getElementById('inventoryQuantity').value;
            const partnerId = document.getElementById('inventorySchool').value;
            const category = document.getElementById('inventoryCategory').value;
            const imageInput = document.getElementById('inventoryImage');

            if (!name) { alert('Nome é obrigatório'); return; }

            const saveBtn = document.getElementById('saveInventoryBtn');
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;

            try {
                let imageUrl = '';
                
                // Upload se houver arquivo selecionado
                if (imageInput.files.length > 0) {
                    const file = imageInput.files[0];
                    // Substituindo Firebase Storage por Google Drive
                    imageUrl = await uploadToDrive(file);
                } else if (currentInventoryId) {
                    // Manter imagem existente se estiver editando e não enviou nova
                    const currentItem = inventory.find(i => i.id === currentInventoryId);
                    imageUrl = currentItem.image || '';
                }

                // Capturar regra de uso se for Insumo
                let usageRule = null;
                if (type === 'Insumo') {
                    const ruleType = document.getElementById('inventoryUsageType').value;
                    if (ruleType === 'unit') usageRule = { type: 'unit', qty: document.getElementById('usageUnitQty').value };
                    if (ruleType === 'batch') usageRule = { type: 'batch', qty: document.getElementById('usageBatchQty').value, limit: document.getElementById('usageBatchLimit').value };
                    if (ruleType === 'order') usageRule = { type: 'order', qty: document.getElementById('usageOrderQty').value };
                }

                const itemData = { 
                    type, name, cost, quantity, image: imageUrl, partnerId, category,
                    usageRule: usageRule // Salva a regra no objeto
                };
                
                if (currentInventoryId) {
                    await updateDoc(doc(db, "inventory", currentInventoryId), itemData);
                } else {
                    await addDoc(collection(db, "inventory"), itemData);
                }
                window.closeInventoryModal();
                fetchInventory();
            } catch (e) {
                console.error("Erro ao salvar estoque:", e);
                alert("Erro ao salvar: " + e.message);
            } finally {
                saveBtn.textContent = 'Salvar';
                saveBtn.disabled = false;
            }
        }

        window.deleteInventory = async (id) => {
            if (confirm('Excluir este item?')) {
                try {
                    await deleteDoc(doc(db, "inventory", id));
                    fetchInventory();
                } catch (e) {
                    console.error("Erro ao excluir:", e);
                }
            }
        }

        // --- Lógica de Compras ---
        window.openPurchaseModal = () => {
            purchaseList = [];
            document.getElementById('purchaseSupplier').value = '';
            document.getElementById('purchaseShipping').value = '';
            document.getElementById('purchaseItemQty').value = '';
            document.getElementById('purchaseItemTotal').value = '';
            renderPurchaseList();
            
            // Popular dropdown
            const select = document.getElementById('purchaseItemSelect');
            select.innerHTML = '<option value="">Selecione um item...</option>';
            inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                select.appendChild(option);
            });

            document.getElementById('purchaseModal').classList.remove('hidden');
            document.getElementById('purchaseModal').classList.add('flex');
        }

        window.closePurchaseModal = () => {
            document.getElementById('purchaseModal').classList.add('hidden');
            document.getElementById('purchaseModal').classList.remove('flex');
        }

        window.addPurchaseItem = () => {
            const itemId = document.getElementById('purchaseItemSelect').value;
            const qty = parseFloat(document.getElementById('purchaseItemQty').value);
            const total = parseFloat(document.getElementById('purchaseItemTotal').value);

            if (!itemId || !qty || !total) {
                alert("Preencha todos os campos do item.");
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            purchaseList.push({
                id: itemId,
                name: item.name,
                qty: qty,
                total: total
            });

            // Limpar campos de item
            document.getElementById('purchaseItemSelect').value = '';
            document.getElementById('purchaseItemQty').value = '';
            document.getElementById('purchaseItemTotal').value = '';
            
            renderPurchaseList();
        }

        window.removePurchaseItem = (index) => {
            purchaseList.splice(index, 1);
            renderPurchaseList();
        }

        function renderPurchaseList() {
            const tbody = document.getElementById('purchaseItemsList');
            tbody.innerHTML = '';
            let totalPurchase = 0;

            purchaseList.forEach((item, index) => {
                totalPurchase += item.total;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2">${item.name}</td>
                    <td class="px-4 py-2">${item.qty}</td>
                    <td class="px-4 py-2">R$ ${item.total.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right">
                        <button onclick="removePurchaseItem(${index})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const shipping = parseFloat(document.getElementById('purchaseShipping').value) || 0;
            document.getElementById('purchaseTotalDisplay').textContent = `R$ ${(totalPurchase + shipping).toFixed(2)}`;
            lucide.createIcons();
        }

        // Atualiza total ao mudar frete
        document.getElementById('purchaseShipping').addEventListener('input', renderPurchaseList);

        window.finalizePurchase = async () => {
            const supplier = document.getElementById('purchaseSupplier').value;
            const shipping = parseFloat(document.getElementById('purchaseShipping').value) || 0;

            if (!supplier || purchaseList.length === 0) {
                alert("Informe o fornecedor e adicione pelo menos um item.");
                return;
            }

            const btn = document.getElementById('finalizePurchaseBtn');
            btn.textContent = 'Processando...';
            btn.disabled = true;

            try {
                const totalItemsValue = purchaseList.reduce((acc, item) => acc + item.total, 0);

                for (const item of purchaseList) {
                    // Calcular frete proporcional ao valor do item
                    const itemShare = item.total / totalItemsValue;
                    const itemShipping = shipping * itemShare;
                    const totalCostForItem = item.total + itemShipping;
                    const unitCostNew = totalCostForItem / item.qty;

                    // Buscar dados atuais do estoque
                    const currentItem = inventory.find(i => i.id === item.id);
                    const currentQty = parseFloat(currentItem.quantity) || 0;
                    const currentCost = parseFloat(currentItem.cost) || 0;

                    // Custo Médio Ponderado
                    const newQty = currentQty + item.qty;
                    const newAvgCost = ((currentQty * currentCost) + (item.qty * unitCostNew)) / newQty;

                    // Atualizar Estoque
                    await updateDoc(doc(db, "inventory", item.id), {
                        quantity: newQty,
                        cost: newAvgCost
                    });

                    // Registrar Movimentação
                    await addDoc(collection(db, "movements"), {
                        date: new Date().toISOString(),
                        type: 'Entrada',
                        itemId: item.id,
                        itemName: item.name,
                        quantity: item.qty,
                        unitValue: unitCostNew,
                        entity: supplier,
                        details: 'Compra'
                    });
                }

                alert("Compra registrada com sucesso!");
                window.closePurchaseModal();
                fetchInventory();
            } catch (e) {
                console.error("Erro na compra:", e);
                alert("Erro ao finalizar compra: " + e.message);
            } finally {
                btn.textContent = 'Finalizar Compra';
                btn.disabled = false;
            }
        }

        // --- Lógica de Movimentações ---
        window.openMovementsModal = async () => {
            document.getElementById('movementsModal').classList.remove('hidden');
            document.getElementById('movementsModal').classList.add('flex');
            
            const tbody = document.getElementById('movementsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Carregando...</td></tr>';

            try {
                const q = await getDocs(collection(db, "movements")); // Idealmente usar orderBy('date', 'desc') mas requer index
                const movements = [];
                q.forEach(doc => movements.push(doc.data()));
                
                // Ordenar localmente por data (desc)
                movements.sort((a, b) => new Date(b.date) - new Date(a.date));

                tbody.innerHTML = '';
                if (movements.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-muted-foreground">Nenhuma movimentação registrada.</td></tr>';
                    return;
                }

                movements.forEach(mov => {
                    const date = new Date(mov.date).toLocaleDateString('pt-BR') + ' ' + new Date(mov.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                    const typeClass = mov.type === 'Entrada' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3">${date}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">${mov.type}</span></td>
                        <td class="px-4 py-3 font-medium">${mov.itemName}</td>
                        <td class="px-4 py-3">${mov.quantity}</td>
                        <td class="px-4 py-3">R$ ${parseFloat(mov.unitValue).toFixed(2)}</td>
                        <td class="px-4 py-3 text-muted-foreground">${mov.entity || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Erro ao buscar movimentações:", e);
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            }
        }

        window.closeMovementsModal = () => {
            document.getElementById('movementsModal').classList.add('hidden');
            document.getElementById('movementsModal').classList.remove('flex');
        }

        // Helper para converter URLs do Drive para formato direto (lh3)
        function getDisplayUrl(url) {
            if (!url) return '';
            // Converte: https://drive.google.com/uc?export=view&id=XYZ
            // Para: https://lh3.googleusercontent.com/d/XYZ
            if (url.includes('drive.google.com') && url.includes('id=')) {
                const match = url.match(/id=([^&]+)/);
                if (match && match[1]) {
                    return `https://lh3.googleusercontent.com/d/${match[1]}`;
                }
            }
            return url;
        }

        // --- Visualização de Imagem ---
        window.openImageModal = (url) => {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('fullSizeImage');
            img.src = getDisplayUrl(url);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeImageModal = () => {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            setTimeout(() => { document.getElementById('fullSizeImage').src = ''; }, 200);
        }

        // --- Lógica de Produtos ---
        window.openProductModal = async (id = null) => {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const nameInput = document.getElementById('productName');
            const printSelect = document.getElementById('productPrint');
            const partnerSelect = document.getElementById('productPartner');
            const imagesPreview = document.getElementById('productImagesPreview');
            const pricingBody = document.getElementById('productPricingBody');
            
            // Resetar
            nameInput.value = '';
            document.getElementById('productImages').value = '';
            imagesPreview.innerHTML = '';
            pricingBody.innerHTML = '';
            currentProductId = id;

            // Popular Select de Estampas
            printSelect.innerHTML = '<option value="">Selecione uma estampa...</option>';
            inventory.filter(i => i.type === 'Estampa').forEach(est => {
                const option = document.createElement('option');
                option.value = est.id;
                option.textContent = est.name;
                printSelect.appendChild(option);
            });

            // Popular Select de Parceiros
            partnerSelect.innerHTML = '<option value="">Produto genérico (sem repasse)</option>';
            partners.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nickname || p.name;
                partnerSelect.appendChild(option);
            });

            if (id) {
                title.textContent = 'Editar Produto';
                try {
                    const docSnap = await getDoc(doc(db, "products", id));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        nameInput.value = data.name || '';
                        printSelect.value = data.printId || '';
                        partnerSelect.value = data.partnerId || '';
                        
                        // Limpar linhas vazias padrão e adicionar as salvas
                        pricingBody.innerHTML = '';
                        if (data.pricing && data.pricing.length > 0) {
                            data.pricing.forEach(p => addProductCategoryRow(p));
                        } else {
                            addProductCategoryRow();
                        }
                    }
                } catch (e) { console.error("Erro ao carregar produto", e); }
            } else {
                title.textContent = 'Novo Produto';
                printSelect.value = '';
                partnerSelect.value = '';
                addProductCategoryRow(); // Adiciona uma linha vazia por padrão
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        // Função auxiliar para adicionar linha de preço
        window.addProductCategoryRow = (data = null) => {
            const tbody = document.getElementById('productPricingBody');
            const row = document.createElement('tr');
            
            const category = data ? data.category : '';
            const sale = data ? data.salePrice : '';
            const cost = data ? data.productionCost : '';
            const school = data ? data.schoolCommission : '';
            const admin = data ? (data.salePrice - data.productionCost - data.schoolCommission).toFixed(2) : '0.00';

            // Obter categorias de Malha do estoque
            const malhaCategories = [...new Set(inventory.filter(i => i.type === 'Malha' && i.category).map(i => i.category))].sort();
            
            let options = '<option value="">Selecione...</option>';
            malhaCategories.forEach(cat => {
                const selected = category === cat ? 'selected' : '';
                options += `<option value="${cat}" ${selected}>${cat}</option>`;
            });

            row.innerHTML = `
                <td class="p-1"><select class="w-full border rounded px-2 py-1 text-xs cat-name">${options}</select></td>
                <td class="p-1"><input type="number" step="0.01" class="w-full border rounded px-2 py-1 text-xs cat-sale" value="${sale}"></td>
                <td class="p-1"><input type="number" step="0.01" class="w-full border rounded px-2 py-1 text-xs cat-cost" value="${cost}"></td>
                <td class="p-1"><input type="number" step="0.01" class="w-full border rounded px-2 py-1 text-xs cat-school" value="${school}"></td>
                <td class="p-1"><input type="number" step="0.01" class="w-full border rounded px-2 py-1 text-xs cat-admin" value="${admin}"></td>
                <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-3 w-3"></i></button></td>
            `;
            tbody.appendChild(row);
            lucide.createIcons();
        }

        window.closeProductModal = () => {
            document.getElementById('productModal').classList.add('hidden');
            document.getElementById('productModal').classList.remove('flex');
        }

        window.saveProduct = async () => {
            const name = document.getElementById('productName').value;
            const printId = document.getElementById('productPrint').value;
            const partnerId = document.getElementById('productPartner').value;
            const imageInput = document.getElementById('productImages');
            
            if (!name) { alert("Nome do produto é obrigatório"); return; }

            // Coletar Preços
            const pricing = [];
            document.querySelectorAll('#productPricingBody tr').forEach(row => {
                const category = row.querySelector('.cat-name').value;
                if (category) {
                    pricing.push({
                        category: category,
                        salePrice: parseFloat(row.querySelector('.cat-sale').value) || 0,
                        productionCost: parseFloat(row.querySelector('.cat-cost').value) || 0,
                        schoolCommission: parseFloat(row.querySelector('.cat-school').value) || 0,
                        adminProfit: parseFloat(row.querySelector('.cat-admin').value) || 0
                    });
                }
            });

            if (pricing.length === 0) { alert("Adicione pelo menos uma categoria de malha/preço."); return; }

            const btn = document.getElementById('saveProductBtn');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            try {
                // Upload de Imagens (Múltiplas)
                let imageUrls = [];
                // Se estiver editando, precisaria manter as antigas, mas por simplificação aqui vamos apenas adicionar novas se enviadas
                // Num cenário real, carregariamos as antigas no array imageUrls antes.
                
                if (imageInput.files.length > 0) {
                    const uploadPromises = Array.from(imageInput.files).map(file => uploadToDrive(file));
                    imageUrls = await Promise.all(uploadPromises);
                }

                const productData = {
                    name,
                    printId,
                    partnerId,
                    pricing,
                    updatedAt: new Date().toISOString()
                };

                if (imageUrls.length > 0) {
                    productData.images = imageUrls; // Salva array de URLs
                }

                if (currentProductId) {
                    await updateDoc(doc(db, "products", currentProductId), productData);
                } else {
                    await addDoc(collection(db, "products"), { ...productData, status: 'Ativo', createdAt: new Date().toISOString() });
                }

                closeProductModal();
                fetchProducts();
            } catch (e) {
                console.error("Erro ao salvar produto:", e);
                alert("Erro ao salvar: " + e.message);
            } finally {
                btn.textContent = 'Salvar Produto';
                btn.disabled = false;
            }
        }

        window.deleteProduct = async (id) => {
            if (confirm('Tem certeza que deseja excluir este produto permanentemente? Isso não pode ser desfeito.')) {
                try {
                    await deleteDoc(doc(db, "products", id));
                    fetchProducts();
                } catch (e) {
                    console.error("Erro ao excluir produto:", e);
                    alert("Erro ao excluir: " + e.message);
                }
            }
        }

        window.toggleProductStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'Ativo' ? 'Inativo' : 'Ativo';
            const confirmMsg = newStatus === 'Inativo' 
                ? 'Deseja inativar este produto? Ele não aparecerá mais no catálogo público.' 
                : 'Deseja reativar este produto?';

            if (confirm(confirmMsg)) {
                try {
                    await updateDoc(doc(db, "products", id), { status: newStatus });
                    fetchProducts();
                } catch (e) {
                    console.error("Erro ao alterar status:", e);
                    alert("Erro ao alterar status: " + e.message);
                }
            }
        }

        // --- Lógica de Pedidos / Kanban ---
        
        async function fetchOrders() {
            try {
                const querySnapshot = await getDocs(collection(db, "orders"));
                window.allOrders = [];
                querySnapshot.forEach((doc) => {
                    window.allOrders.push({ id: doc.id, ...doc.data() });
                });
                renderProductionList(window.allOrders);
                renderDashboard(); // Atualiza dashboard se estiver na aba
            } catch (error) {
                console.error("Erro ao buscar pedidos:", error);
            }
        }

        window.switchProductionStatus = (status) => {
            currentProductionStatus = status;
            
            // Se chamou via aba de produção, garante que a lista renderize
            if(document.getElementById('production').classList.contains('active')) {
                renderProductionList(window.allOrders);
            }

            selectedOrderIds.clear(); // Limpar seleção ao mudar de aba
            updateSelectionUI();
            
            // Atualizar UI dos botões
            document.querySelectorAll('.prod-tab-btn').forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Normalizar ID para seleção (remove acentos e lowercase)
            const normalizedId = status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const activeBtn = document.getElementById(`tab-prod-${normalizedId}`);
            if (activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-gray-500');
                activeBtn.classList.add('border-primary', 'text-primary');
            }

            fetchOrders(); // Recarrega a lista filtrada
        }

        function renderProductionList(orders) {
            const container = document.getElementById('production-list-container');
            container.innerHTML = '';

            // Filtro de Status
            let filteredOrders = orders.filter(o => (o.status || 'Orçamento') === currentProductionStatus);

            // Filtro de Pagamento
            const filterPayment = document.getElementById('productionFilterPayment')?.value;
            if (filterPayment) {
                // Se o filtro for "Pendente", pega tanto "Pendente" quanto vazio/null
                filteredOrders = filteredOrders.filter(o => (o.paymentStatus || 'Pendente') === filterPayment);
            }

            if (filteredOrders.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">Nenhum pedido em "${currentProductionStatus}"</div>`;
                return;
            }

            filteredOrders.forEach(order => {
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? (partner.nickname || partner.name) : 'Geral';
                
                const hasError = order.hasError;
                const errorIndicator = hasError ? `<i data-lucide="alert-triangle" class="h-3.5 w-3.5 text-destructive" title="Este pedido teve um erro de produção registrado."></i>` : '';

                // Botão de Aprovar apenas se for Orçamento
                const approveBtn = currentProductionStatus === 'Orçamento' 
                    ? `<button onclick="openConfirmOrderModal('${order.id}')" class="w-full mt-2 bg-green-600 text-white text-xs py-1.5 rounded hover:bg-green-700 flex items-center justify-center gap-1"><i data-lucide="check" class="h-3 w-3"></i> Aprovar</button>` 
                    : '';

                // Botão de Etiqueta (Produção em diante)
                const showLabelBtn = ['Produção', 'Finalizado', 'Entregue'].includes(currentProductionStatus);
                const labelBtn = showLabelBtn
                    ? `<button onclick="printOrderLabel('${order.id}')" class="p-1.5 hover:bg-purple-50 text-purple-600 rounded bg-purple-50" title="Imprimir Etiqueta"><i data-lucide="tag" class="h-3.5 w-3.5"></i></button>` : '';

                // Botão de Erro
                const showErrorBtn = ['Produção', 'Finalizado'].includes(currentProductionStatus);
                const errorBtn = showErrorBtn
                    ? `<button onclick="openErrorModal('${order.id}')" class="p-1.5 hover:bg-red-50 text-red-600 rounded bg-red-50" title="Reportar Erro de Produção"><i data-lucide="alert-triangle" class="h-3.5 w-3.5"></i></button>` : '';
                
                // Checkbox de seleção (apenas para Pendente e Produção)
                const showCheckbox = currentProductionStatus === 'Pendente' || currentProductionStatus === 'Produção';
                const checkboxHtml = showCheckbox 
                    ? `<input type="checkbox" onchange="toggleOrderSelection('${order.id}')" class="absolute top-4 right-4 h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary z-10" ${selectedOrderIds.has(order.id) ? 'checked' : ''}>` 
                    : '';

                // Gerar HTML da lista de itens
                let itemsHtml = '';
                if (order.items && order.items.length > 0) {
                    itemsHtml = '<div class="mt-3 pt-2 border-t border-gray-100 text-xs text-gray-600 space-y-1 bg-gray-50 p-2 rounded">';
                    order.items.forEach(item => {
                        itemsHtml += `<div class="flex justify-between items-center"><span><span class="font-bold">${item.qty}x</span> ${item.name}</span> <span class="font-mono bg-white px-1 rounded border border-gray-100">${item.category || ''} ${item.size || '-'}</span></div>`;
                    });
                    itemsHtml += '</div>';
                }

                const hasObservation = order.observation && order.observation.trim() !== '';
                const obsStyle = hasObservation ? 'border-r-4 border-r-yellow-500' : '';

                const card = document.createElement('div');
                // Adicionado 'relative' para que o checkbox absolute funcione corretamente
                card.className = `bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow flex flex-col h-full ${obsStyle} relative`;
                card.innerHTML = `
                    ${checkboxHtml}
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <div class="font-bold text-sm text-gray-800">${order.clientName}</div>
                            <div class="text-xs font-medium text-blue-600">${order.studentName || ''}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${errorIndicator}
                            <span class="text-xs font-mono text-gray-400">#${order.id.slice(-4)}</span>
                        </div>
                    </div>
                    ${hasObservation ? `<div class="text-[10px] text-yellow-700 bg-yellow-50 p-1 rounded mb-2 border border-yellow-100 flex items-start gap-1"><i data-lucide="alert-circle" class="h-3 w-3 shrink-0 mt-0.5"></i> <span class="line-clamp-2">${order.observation}</span></div>` : ''}
                    
                    <div class="text-xs text-gray-500 mb-3 flex items-center gap-1 mt-1">
                        <i data-lucide="building-2" class="h-3 w-3"></i> ${partnerName}
                    </div>

                    <div class="mt-auto pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-primary text-sm">R$ ${parseFloat(order.total).toFixed(2)}</span>
                            <div class="flex gap-1">
                                <button onclick="sendOrderToWhatsapp('${order.id}')" class="p-1.5 hover:bg-green-50 text-green-600 rounded bg-green-50" title="WhatsApp"><i data-lucide="message-circle" class="h-3.5 w-3.5"></i></button>
                                ${labelBtn}
                                ${errorBtn}
                                <button onclick="window.openOrderModal('${order.id}')" class="p-1.5 hover:bg-blue-50 text-blue-600 rounded bg-blue-50" title="Editar"><i data-lucide="pencil" class="h-3.5 w-3.5"></i></button>
                                <button onclick="window.deleteOrder('${order.id}')" class="p-1.5 hover:bg-red-50 text-red-600 rounded bg-red-50" title="Excluir"><i data-lucide="trash-2" class="h-3.5 w-3.5"></i></button>
                            </div>
                        </div>
                        
                        ${approveBtn}

                        ${currentProductionStatus !== 'Orçamento' ? `
                        <div class="mt-2">
                            <select onchange="updateOrderStatus('${order.id}', this.value)" class="text-[10px] border rounded bg-gray-50 p-1 w-full cursor-pointer focus:ring-1 focus:ring-primary outline-none">
                                <option value="Pendente" ${currentProductionStatus === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="Produção" ${currentProductionStatus === 'Produção' ? 'selected' : ''}>Produção</option>
                                <option value="Finalizado" ${currentProductionStatus === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
                                <option value="Entregue" ${currentProductionStatus === 'Entregue' ? 'selected' : ''}>Entregue</option>
                                <option value="Arquivado" ${currentProductionStatus === 'Arquivado' ? 'selected' : ''}>Arquivado</option>
                            </select>
                        </div>` : ''}

                        ${itemsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
            
            lucide.createIcons();
        }

        // --- Lógica de Seleção e Relatório ---
        window.toggleOrderSelection = (id) => {
            if (selectedOrderIds.has(id)) {
                selectedOrderIds.delete(id);
            } else {
                selectedOrderIds.add(id);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedOrderIds.size;
            document.getElementById('selected-count').textContent = count;
            const actions = document.getElementById('production-actions');
            if (count > 0) {
                actions.classList.remove('hidden');
            } else {
                actions.classList.add('hidden');
            }
        }

        window.generateMaterialReport = async () => {
            // 1. Buscar todos os pedidos ativos para calcular reserva
            const allOrdersSnap = await getDocs(collection(db, "orders"));
            const allOrders = [];
            allOrdersSnap.forEach(doc => allOrders.push({id: doc.id, ...doc.data()}));

            // Filtra pedidos ativos (Pendente/Produção)
            const activeOrders = allOrders.filter(o => o.status === 'Pendente' || o.status === 'Produção');

            // Mapas de cálculo
            const needs = {}; // O que os selecionados precisam
            const reserved = {}; // O que os OUTROS ativos precisam

            // Função auxiliar para somar materiais
            const calculateMaterials = (order, targetMap) => {
                if (!order.items) return;
                
                // A. Itens do Pedido (Malhas e Estampas)
                order.items.forEach(item => {
                    // 1. Malha (Baseado no Tamanho/Variação que é o nome do item no estoque)
                    // Procura no estoque um item do tipo Malha com esse nome e categoria
                    const malhaItem = inventory.find(i => i.type === 'Malha' && i.name === item.size && i.category === item.category);
                    if (malhaItem) {
                        targetMap[malhaItem.id] = (targetMap[malhaItem.id] || 0) + item.qty;
                    }

                    // 2. Estampa (Baseado no Produto -> printId)
                    // Precisamos achar o produto original para pegar o printId
                    // Como não temos a lista de produtos completa aqui fácil, vamos assumir que o estoque de estampas tem o ID salvo ou buscar.
                    // Melhor: Vamos iterar os produtos carregados (fetchProducts já rodou)
                    // Nota: `products` variável global pode não estar populada se não abriu a aba. Vamos garantir.
                });

                // B. Insumos (Regras Globais)
                inventory.filter(i => i.type === 'Insumo').forEach(insumo => {
                    let qtyNeeded = 0;
                    const rule = insumo.usageRule || { type: 'unit', qty: 1 };
                    
                    if (rule.type === 'unit') {
                        // Soma total de itens no pedido
                        const totalItems = order.items.reduce((acc, i) => acc + i.qty, 0);
                        qtyNeeded = totalItems * (parseFloat(rule.qty) || 1);
                    } else if (rule.type === 'order') {
                        qtyNeeded = (parseFloat(rule.qty) || 1);
                    } else if (rule.type === 'batch') {
                        const totalItems = order.items.reduce((acc, i) => acc + i.qty, 0);
                        const limit = parseFloat(rule.limit) || 1;
                        qtyNeeded = Math.ceil(totalItems / limit) * (parseFloat(rule.qty) || 1);
                    }
                    
                    if (qtyNeeded > 0) {
                        targetMap[insumo.id] = (targetMap[insumo.id] || 0) + qtyNeeded;
                    }
                });
            };

            // Calcular necessidades
            // Precisamos iterar os pedidos selecionados e buscar os produtos para ver as estampas
            // Para simplificar, vamos fazer um loop assíncrono se precisar buscar produtos, mas tentaremos usar o cache
            
            // Garantir produtos carregados para link de estampa
            if (!window.cachedProducts) {
                const pSnap = await getDocs(collection(db, "products"));
                window.cachedProducts = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
            }

            const processOrder = (order, targetMap) => {
                if (!order.items) return;
                order.items.forEach(item => {
                    // Malha
                    const malhaItem = inventory.find(i => i.type === 'Malha' && i.name === item.size && i.category === item.category);
                    if (malhaItem) targetMap[malhaItem.id] = (targetMap[malhaItem.id] || 0) + item.qty;

                    // Estampa
                    const prod = window.cachedProducts.find(p => p.id === item.productId);
                    if (prod && prod.printId) {
                        targetMap[prod.printId] = (targetMap[prod.printId] || 0) + item.qty;
                    }
                });
                // Insumos (código repetido da lógica acima, simplificado aqui)
                inventory.filter(i => i.type === 'Insumo').forEach(insumo => {
                    let q = 0;
                    const r = insumo.usageRule || {type:'unit', qty:1};
                    const total = order.items.reduce((a,b)=>a+b.qty,0);
                    if(r.type==='unit') q = total * r.qty;
                    if(r.type==='order') q = parseFloat(r.qty);
                    if(r.type==='batch') q = Math.ceil(total/r.limit)*r.qty;
                    if(q>0) targetMap[insumo.id] = (targetMap[insumo.id]||0)+q;
                });
            };

            activeOrders.forEach(order => {
                if (selectedOrderIds.has(order.id)) {
                    processOrder(order, needs);
                } else {
                    processOrder(order, reserved);
                }
            });

            // Renderizar Relatório
            const needsBody = document.getElementById('reportNeedsBody');
            const missingBody = document.getElementById('reportMissingBody');
            needsBody.innerHTML = '';
            missingBody.innerHTML = '';

            Object.keys(needs).forEach(itemId => {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;

                const qtyNeeded = needs[itemId];
                const qtyReserved = reserved[itemId] || 0;
                const currentStock = parseFloat(item.quantity) || 0;
                const netStock = currentStock - qtyReserved;
                const missing = Math.max(0, qtyNeeded - netStock);

                // Linha de Necessidade
                const trNeed = document.createElement('tr');
                trNeed.innerHTML = `<td class="p-2 border-b">${item.name} <span class="text-xs text-gray-500">(${item.category || item.type})</span></td><td class="p-2 border-b text-right font-bold">${qtyNeeded}</td>`;
                needsBody.appendChild(trNeed);

                // Linha de Falta (se houver)
                if (missing > 0) {
                    const trMiss = document.createElement('tr');
                    trMiss.innerHTML = `
                        <td class="p-2 border-b text-red-700 font-medium">${item.name} <span class="text-xs text-red-400">(${item.category || item.type})</span></td>
                        <td class="p-2 border-b text-right text-red-700 font-bold">${missing}</td>
                        <td class="p-2 border-b text-right text-gray-500">${currentStock} (Disp: ${netStock})</td>
                    `;
                    missingBody.appendChild(trMiss);
                }
            });

            if (missingBody.children.length === 0) {
                missingBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-green-600 font-medium">Estoque suficiente para os pedidos selecionados!</td></tr>';
            }

            const modal = document.getElementById('materialReportModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.openOrderModal = async (id = null) => {
            currentOrderId = id;
            orderList = [];
            
            // Resetar campos
            document.getElementById('orderClientName').value = '';
            document.getElementById('orderClientPhone').value = '';
            document.getElementById('orderPartner').value = '';
            document.getElementById('orderStudentName').value = '';
            document.getElementById('orderObservation').value = '';
            
            // Configuração inicial do campo Estudante (Oculto por padrão)
            const studentContainer = document.getElementById('orderStudentContainer');
            studentContainer.classList.add('hidden');
            
            document.getElementById('orderProductQty').value = 1;
            document.getElementById('orderProductPrice').value = '';
            
            // Popular Select de Parceiros
            const partnerSelect = document.getElementById('orderPartner');
            partnerSelect.innerHTML = '<option value="">Selecione...</option>';
            
            // Filtrar apenas Escola e Revendedor
            const validPartners = partners.filter(p => {
                const cat = String(p.category || '').trim();
                // Usa Regex para garantir que pegue Escola/Revendedor independente de maiúsculas/minúsculas
                return /^escola$/i.test(cat) || /^revendedor$/i.test(cat);
            });
            
            // Ordenar alfabeticamente para facilitar a busca
            validPartners.sort((a, b) => {
                const nameA = (a.nickname || a.name || '').toLowerCase();
                const nameB = (b.nickname || b.name || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            validPartners.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.nickname || p.name} - ${p.category}`;
                option.dataset.category = p.category;
                partnerSelect.appendChild(option);
            });

            // Listener para mostrar/esconder nome do estudante
            partnerSelect.onchange = () => {
                const selectedOption = partnerSelect.options[partnerSelect.selectedIndex];
                const category = selectedOption && selectedOption.dataset.category 
                    ? String(selectedOption.dataset.category).trim() 
                    : '';
                
                if (/^escola$/i.test(category)) {
                    studentContainer.classList.remove('hidden');
                } else {
                    studentContainer.classList.add('hidden');
                    document.getElementById('orderStudentName').value = '';
                }
            };

            // Popular Select de Produtos (Carregar produtos do banco)
            const productSelect = document.getElementById('orderProductSelect');
            productSelect.innerHTML = '<option value="">Selecione...</option>';
            // Resetar selects dependentes
            document.getElementById('orderProductCategory').innerHTML = '<option value="">Selecione...</option>';
            document.getElementById('orderProductSize').innerHTML = '<option value="">Selecione...</option>';

            const prodSnap = await getDocs(collection(db, "products"));
            prodSnap.forEach(doc => {
                const p = doc.data();
                // Filtrar apenas produtos ativos se necessário, ou mostrar todos
                if (p.status !== 'Inativo') {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = p.name;
                    // Guardar preço base no dataset para facilitar
                    const price = p.pricing && p.pricing.length > 0 ? p.pricing[0].salePrice : 0;
                    option.dataset.price = price;
                    if (p.pricing) {
                        option.dataset.pricing = JSON.stringify(p.pricing);
                    }
                    productSelect.appendChild(option);
                }
            });

            // Evento para atualizar preço ao selecionar produto
            productSelect.onchange = () => {
                const price = productSelect.options[productSelect.selectedIndex].dataset.price;
                document.getElementById('orderProductPrice').value = price || '';
                window.onOrderProductChange();
            };

            if (id) {
                document.getElementById('orderModalTitle').textContent = 'Editar Orçamento';
                const docSnap = await getDoc(doc(db, "orders", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('orderClientName').value = data.clientName;
                    document.getElementById('orderClientPhone').value = data.clientPhone;
                    document.getElementById('orderPartner').value = data.partnerId;
                    
                    // Verificar visibilidade do estudante ao editar
                    const partner = partners.find(p => p.id === data.partnerId);
                    if (partner && /^escola$/i.test(partner.category || '')) {
                        document.getElementById('orderStudentContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('orderStudentContainer').classList.add('hidden');
                    }

                    if (data.studentName) {
                        document.getElementById('orderStudentName').value = data.studentName;
                    }
                    document.getElementById('orderObservation').value = data.observation || '';
                    orderList = data.items || [];
                }
            } else {
                document.getElementById('orderModalTitle').textContent = 'Novo Orçamento';
            }

            renderOrderItems();
            document.getElementById('orderModal').classList.remove('hidden');
            document.getElementById('orderModal').classList.add('flex');
        }

        window.closeOrderModal = () => {
            document.getElementById('orderModal').classList.add('hidden');
            document.getElementById('orderModal').classList.remove('flex');
        }

        window.onOrderProductChange = () => {
            const productSelect = document.getElementById('orderProductSelect');
            const categorySelect = document.getElementById('orderProductCategory');
            const sizeSelect = document.getElementById('orderProductSize');
            const priceInput = document.getElementById('orderProductPrice');
            
            categorySelect.innerHTML = '<option value="">Selecione...</option>';
            sizeSelect.innerHTML = '<option value="">Selecione...</option>';
            priceInput.value = '';

            const selectedOption = productSelect.options[productSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.pricing) {
                const pricing = JSON.parse(selectedOption.dataset.pricing);
                pricing.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.category;
                    option.textContent = p.category;
                    option.dataset.price = p.salePrice;
                    categorySelect.appendChild(option);
                });
            }
        }

        window.onOrderCategoryChange = () => {
            const categorySelect = document.getElementById('orderProductCategory');
            const sizeSelect = document.getElementById('orderProductSize');
            const priceInput = document.getElementById('orderProductPrice');
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
            }

            // Popular Tamanhos/Variações do Estoque
            sizeSelect.innerHTML = '<option value="">Selecione...</option>';
            const categoryName = categorySelect.value;
            
            if (categoryName) {
                // Filtra itens do estoque que são 'Malha' e da categoria selecionada
                const variations = inventory.filter(i => i.type === 'Malha' && i.category === categoryName);
                
                variations.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.name;
                    option.textContent = v.name;
                    sizeSelect.appendChild(option);
                });

                if (variations.length === 0) {
                     // Fallback para tamanhos padrões se não houver variações no estoque
                     const standardSizes = ["2", "4", "6", "8", "10", "12", "14", "16", "P", "M", "G", "GG", "XG"];
                     standardSizes.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s;
                        option.textContent = s;
                        sizeSelect.appendChild(option);
                     });
                }
            }
        }

        window.addOrderProduct = () => {
            const select = document.getElementById('orderProductSelect');
            const productId = select.value;
            const productName = select.options[select.selectedIndex].text;
            const category = document.getElementById('orderProductCategory').value;
            const size = document.getElementById('orderProductSize').value;
            const qty = parseFloat(document.getElementById('orderProductQty').value);
            const price = parseFloat(document.getElementById('orderProductPrice').value);

            if (!productId || !qty || isNaN(price)) {
                alert("Selecione um produto, quantidade e verifique o valor.");
                return;
            }

            orderList.push({ productId, name: productName, category, size, qty, price, total: qty * price });
            renderOrderItems();
            
            // Resetar inputs de produto
            select.value = '';
            document.getElementById('orderProductCategory').innerHTML = '<option value="">Selecione...</option>';
            document.getElementById('orderProductSize').innerHTML = '<option value="">Selecione...</option>';
            document.getElementById('orderProductQty').value = 1;
            document.getElementById('orderProductPrice').value = '';
        }

        window.removeOrderProduct = (index) => {
            orderList.splice(index, 1);
            renderOrderItems();
        }

        function renderOrderItems() {
            const tbody = document.getElementById('orderItemsList');
            tbody.innerHTML = '';
            let total = 0;

            orderList.forEach((item, index) => {
                total += item.total;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2">${item.name}</td>
                    <td class="px-4 py-2 text-xs text-gray-600">${item.category || '-'} / ${item.size || '-'}</td>
                    <td class="px-4 py-2">${item.qty}</td>
                    <td class="px-4 py-2">R$ ${item.total.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right">
                        <button onclick="removeOrderProduct(${index})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('orderTotalDisplay').textContent = `R$ ${total.toFixed(2)}`;
            lucide.createIcons();
        }

        window.saveOrder = async () => {
            const clientName = document.getElementById('orderClientName').value;
            const clientPhone = document.getElementById('orderClientPhone').value;
            const partnerId = document.getElementById('orderPartner').value;
            const studentName = document.getElementById('orderStudentName').value;
            const observation = document.getElementById('orderObservation').value;

            if (!clientName || orderList.length === 0) {
                alert("Informe o nome do cliente e adicione pelo menos um produto.");
                return;
            }

            const total = orderList.reduce((acc, item) => acc + item.total, 0);
            const orderData = {
                clientName,
                clientPhone,
                partnerId,
                studentName,
                observation,
                items: orderList,
                total,
                updatedAt: new Date().toISOString()
            };

            const btn = document.getElementById('saveOrderBtn');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            try {
                if (currentOrderId) {
                    await updateDoc(doc(db, "orders", currentOrderId), orderData);
                } else {
                    await addDoc(collection(db, "orders"), { 
                        ...orderData, 
                        status: 'Orçamento', 
                        createdAt: new Date().toISOString() 
                    });
                }
                closeOrderModal();
                fetchOrders();
            } catch (e) {
                console.error("Erro ao salvar pedido:", e);
                alert("Erro ao salvar: " + e.message);
            } finally {
                btn.textContent = 'Salvar Orçamento';
                btn.disabled = false;
            }
        }

        window.deleteOrder = async (id) => {
            if (confirm('Excluir este orçamento/pedido?')) {
                try {
                    await deleteDoc(doc(db, "orders", id));
                    fetchOrders();
                } catch (e) {
                    console.error("Erro ao excluir:", e);
                }
            }
        }

        // --- Lógica de Confirmação de Orçamento ---
        window.toggleSinalInput = () => {
            const status = document.getElementById('confirmPaymentStatus').value;
            const container = document.getElementById('confirmSinalContainer');
            if (status === 'Pago Parcial') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        window.openConfirmOrderModal = (orderId) => {
            orderToConfirmId = orderId;
            const modal = document.getElementById('confirmOrderModal');
            const producerSelect = document.getElementById('confirmProducer');
            
            // Popular select de produtores (Produção ou ADM)
            producerSelect.innerHTML = '<option value="">Selecione...</option>';
            const producers = partners.filter(p => {
                const cat = (p.category || '').trim().toLowerCase();
                return cat === 'produção' || cat === 'producao' || cat === 'adm';
            });
            
            producers.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nickname || p.name;
                producerSelect.appendChild(option);
            });

            // Resetar campos
            document.getElementById('confirmPaymentStatus').value = 'Pendente';
            document.getElementById('confirmSinalValue').value = '';
            window.toggleSinalInput();

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.confirmOrderAction = async () => {
            const paymentStatus = document.getElementById('confirmPaymentStatus').value;
            const producerId = document.getElementById('confirmProducer').value;
            let downPayment = 0;
            
            if (!producerId) {
                alert("Selecione quem irá produzir.");
                return;
            }

            if (paymentStatus === 'Pago Parcial') {
                downPayment = parseFloat(document.getElementById('confirmSinalValue').value);
                if (!downPayment || downPayment <= 0) {
                    alert("Informe o valor do sinal para controle financeiro.");
                    return;
                }
            }

            const btn = document.getElementById('btnConfirmOrderAction');
            btn.textContent = 'Processando...';
            btn.disabled = true;

            try {
                // 1. Buscar dados do pedido
                const orderSnap = await getDoc(doc(db, "orders", orderToConfirmId));
                const orderData = orderSnap.data();

                // 2. Criar Cliente se não existir (verificação simples por telefone)
                // Nota: Em produção real, faria uma query para verificar duplicidade.
                // Aqui vamos adicionar direto para garantir o registro solicitado.
                await addDoc(collection(db, "clients"), {
                    name: orderData.clientName,
                    phone: orderData.clientPhone,
                    partnerId: orderData.partnerId,
                    studentName: orderData.studentName || '',
                    lastPurchase: new Date().toISOString()
                });

                // 3. Atualizar Pedido
                await updateDoc(doc(db, "orders", orderToConfirmId), {
                    status: 'Pendente',
                    paymentStatus: paymentStatus,
                    producerId: producerId,
                    approvedAt: new Date().toISOString(),
                    downPayment: downPayment
                });

                document.getElementById('confirmOrderModal').classList.add('hidden');
                document.getElementById('confirmOrderModal').classList.remove('flex');
                fetchOrders(); // Atualiza a tela (vai sumir da aba Orçamento)

            } catch (e) {
                console.error("Erro ao confirmar:", e);
                alert("Erro ao confirmar pedido: " + e.message);
            } finally {
                btn.textContent = 'Confirmar e Produzir';
                btn.disabled = false;
            }
        }

        window.updateOrderStatus = async (id, newStatus) => {
            try {
                const updateData = { status: newStatus };
                
                // Buscar pedido atual para saber o status anterior
                const orderSnap = await getDoc(doc(db, "orders", id));
                const order = orderSnap.data();
                const oldStatus = order.status || 'Orçamento';

                // Definir quais status consideram o estoque "baixado"
                const deductedStatuses = ['Finalizado', 'Entregue'];
                
                const wasDeducted = deductedStatuses.includes(oldStatus);
                const willBeDeducted = deductedStatuses.includes(newStatus);

                // Carregar produtos para referência de estampas (se necessário)
                if (!window.cachedProducts) {
                    const pSnap = await getDocs(collection(db, "products"));
                    window.cachedProducts = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
                }

                // Função auxiliar para calcular materiais e atualizar estoque
                const adjustStock = async (multiplier) => {
                    const materialsMap = {};
                    
                    if (order.items) {
                        order.items.forEach(item => {
                            // Malha
                            const malhaItem = inventory.find(i => i.type === 'Malha' && i.name === item.size && i.category === item.category);
                            if (malhaItem) materialsMap[malhaItem.id] = (materialsMap[malhaItem.id] || 0) + item.qty;

                            // Estampa
                            const prod = window.cachedProducts.find(p => p.id === item.productId);
                            if (prod && prod.printId) materialsMap[prod.printId] = (materialsMap[prod.printId] || 0) + item.qty;
                        });

                        // Insumos
                        inventory.filter(i => i.type === 'Insumo').forEach(insumo => {
                            let q = 0;
                            const r = insumo.usageRule || {type:'unit', qty:1};
                            const total = order.items.reduce((a,b)=>a+b.qty,0);
                            if(r.type==='unit') q = total * r.qty;
                            if(r.type==='order') q = parseFloat(r.qty);
                            if(r.type==='batch') q = Math.ceil(total/r.limit)*r.qty;
                            if(q>0) materialsMap[insumo.id] = (materialsMap[insumo.id]||0)+q;
                        });
                    }

                    for (const [itemId, qty] of Object.entries(materialsMap)) {
                        const invItem = inventory.find(i => i.id === itemId);
                        if (invItem) {
                            // Multiplier -1 para baixar, +1 para devolver
                            const newQty = (parseFloat(invItem.quantity) || 0) + (qty * multiplier);
                            await updateDoc(doc(db, "inventory", itemId), { quantity: newQty });
                        }
                    }
                    await fetchInventory();
                };

                // Lógica de Transição
                if (!wasDeducted && willBeDeducted) {
                    // Baixar Estoque (Multiplicador -1)
                    await adjustStock(-1);
                } else if (wasDeducted && !willBeDeducted) {
                    // Devolver Estoque (Multiplicador +1)
                    await adjustStock(1);
                }
                // Se ambos forem deducted (ex: Finalizado -> Entregue), não faz nada.
                // Se ambos não forem deducted (ex: Pendente -> Produção), não faz nada.

                // Se mudar para Entregue, salva a data de entrega para contar os 30 dias
                if (newStatus === 'Entregue') {
                    updateData.deliveredAt = new Date().toISOString();
                }

                await updateDoc(doc(db, "orders", id), updateData);
                fetchOrders(); 
            } catch (e) {
                console.error("Erro ao atualizar status:", e);
            }
        }

        // Helper function to calculate materials for a given item and quantity
        const getMaterialsForErrorItem = (item, qty) => {
            const updates = {};
            // 1. Malha
            const malhaItem = inventory.find(i => i.type === 'Malha' && i.name === item.size && i.category === item.category);
            if (malhaItem) {
                updates[malhaItem.id] = (updates[malhaItem.id] || 0) + qty;
            }

            // 2. Estampa
            const prod = window.cachedProducts.find(p => p.id === item.productId);
            if (prod && prod.printId) {
                updates[prod.printId] = (updates[prod.printId] || 0) + qty;
            }

            // 3. Insumos (unitários)
            inventory.filter(i => i.type === 'Insumo').forEach(insumo => {
                const r = insumo.usageRule || {type:'unit', qty:1};
                if(r.type === 'unit') {
                    const q = qty * (parseFloat(r.qty) || 1);
                    if(q > 0) updates[insumo.id] = (updates[insumo.id] || 0) + q;
                }
            });
            return updates;
        }

        // --- Lógica de Erros de Produção ---
        window.openErrorModal = (orderId) => {
            errorToReportId = orderId;
            const order = window.allOrders.find(o => o.id === orderId);
            if (!order) return;

            const tbody = document.getElementById('errorItemsList');
            tbody.innerHTML = '';
            document.getElementById('errorReason').value = '';

            order.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.dataset.index = index;
                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.category} / ${item.size}</div>
                    </td>
                    <td class="px-4 py-3 text-center">${item.qty}</td>
                    <td class="px-4 py-3">
                        <input type="number" min="0" max="${item.qty}" class="error-qty-input w-full border rounded px-2 py-1 text-center focus:outline-none focus:ring-2 focus:ring-destructive" placeholder="0">
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const modal = document.getElementById('errorModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeErrorModal = () => {
            const modal = document.getElementById('errorModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.saveProductionError = async () => {
            const reason = document.getElementById('errorReason').value;
            if (!reason) {
                alert("Por favor, descreva o motivo do erro.");
                return;
            }

            const order = window.allOrders.find(o => o.id === errorToReportId);
            if (!order) return;

            const btn = document.getElementById('saveErrorBtn');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            try {
                const errorPromises = [];
                const errorInputs = document.querySelectorAll('.error-qty-input');
                const inventoryUpdates = {}; // itemId -> quantidade para baixar

                // Garantir produtos carregados para referência de estampa
                if (!window.cachedProducts) {
                    const pSnap = await getDocs(collection(db, "products"));
                    window.cachedProducts = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
                }

                let hasErrors = false;

                errorInputs.forEach(input => {
                    const errorQty = parseInt(input.value);
                    if (errorQty > 0) {
                        hasErrors = true;
                        const tr = input.closest('tr');
                        const itemIndex = parseInt(tr.dataset.index);
                        const item = order.items[itemIndex];

                        const errorData = {
                            orderId: order.id,
                            clientName: order.clientName,
                            productName: item.name,
                            category: item.category,
                            size: item.size,
                            errorQty: errorQty,
                            reason: reason,
                            createdAt: new Date().toISOString()
                        };
                        errorPromises.push(addDoc(collection(db, "productionErrors"), errorData));

                        const materialsToDeduct = getMaterialsForErrorItem(item, errorQty);
                        for (const [itemId, qty] of Object.entries(materialsToDeduct)) {
                            inventoryUpdates[itemId] = (inventoryUpdates[itemId] || 0) + qty;
                        }
                    }
                });

                if (!hasErrors) {
                    alert("Nenhuma quantidade de erro foi inserida.");
                    btn.textContent = 'Registrar Perda';
                    btn.disabled = false;
                    return;
                }

                // Executar atualizações de estoque (Baixa por Perda)
                for (const [itemId, qty] of Object.entries(inventoryUpdates)) {
                    const invItem = inventory.find(i => i.id === itemId);
                    if (invItem) {
                        const currentQty = parseFloat(invItem.quantity) || 0;
                        const newQty = currentQty - qty;
                        
                        // Atualizar documento do estoque
                        errorPromises.push(updateDoc(doc(db, "inventory", itemId), { quantity: newQty }));
                        
                        // Registrar Movimentação de Saída/Perda
                        errorPromises.push(addDoc(collection(db, "movements"), {
                            date: new Date().toISOString(),
                            type: 'Saída',
                            itemId: itemId,
                            itemName: invItem.name,
                            quantity: qty,
                            unitValue: invItem.cost || 0,
                            entity: 'Produção (Erro)',
                            details: `Perda no pedido #${order.id.slice(-4)}: ${reason}`
                        }));
                    }
                }

                // Marcar o pedido como tendo um erro
                errorPromises.push(updateDoc(doc(db, "orders", order.id), { hasError: true }));

                await Promise.all(errorPromises);

                alert("Erro registrado e materiais baixados do estoque.");
                closeErrorModal();
                fetchOrders(); // Para atualizar o indicador na UI
                fetchErrors(); // Para atualizar a lista de erros
                fetchInventory(); // Atualizar UI de estoque

            } catch (e) {
                console.error("Erro ao registrar erro de produção:", e);
                alert("Erro ao salvar: " + e.message);
            } finally {
                btn.textContent = 'Registrar Perda';
                btn.disabled = false;
            }
        }

        // --- Lógica de Edição e Exclusão de Erros ---
        window.openEditErrorModal = (id) => {
            currentErrorId = id;
            const error = productionErrors.find(e => e.id === id);
            if (!error) return;

            document.getElementById('editErrorProductInfo').textContent = `${error.productName} (${error.category} / ${error.size})`;
            document.getElementById('editErrorOrderInfo').textContent = `Pedido #${error.orderId.slice(-4)} - ${error.clientName}`;
            document.getElementById('editErrorQty').value = error.errorQty;
            document.getElementById('editErrorReason').value = error.reason;
            
            // Store original quantity to calculate diff on save
            document.getElementById('editErrorQty').dataset.originalQty = error.errorQty;

            const modal = document.getElementById('editErrorModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeEditErrorModal = () => {
            document.getElementById('editErrorModal').classList.add('hidden');
            document.getElementById('editErrorModal').classList.remove('flex');
            currentErrorId = null;
        }

        window.saveEditedError = async () => {
            if (!currentErrorId) return;

            const originalError = productionErrors.find(e => e.id === currentErrorId);
            if (!originalError) return;

            const newQty = parseInt(document.getElementById('editErrorQty').value);
            const newReason = document.getElementById('editErrorReason').value;
            const originalQty = parseInt(document.getElementById('editErrorQty').dataset.originalQty);

            if (isNaN(newQty) || newQty <= 0) {
                alert("A quantidade com erro deve ser um número maior que zero.");
                return;
            }

            const btn = document.getElementById('saveEditedErrorBtn');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            try {
                const updatePromises = [];
                const qtyDifference = newQty - originalQty;

                // Se a quantidade mudou, ajustar o estoque
                if (qtyDifference !== 0) {
                    const order = window.allOrders.find(o => o.id === originalError.orderId);
                    const errorItem = order.items.find(i => i.name === originalError.productName && i.category === originalError.category && i.size === originalError.size);

                    if (errorItem) {
                        // Multiplier é -1. Se a diferença for positiva (2->5), precisamos deduzir mais 3. Se for negativa (5->2), precisamos devolver 3.
                        const multiplier = -1; 
                        const materialsToAdjust = getMaterialsForErrorItem(errorItem, qtyDifference);
                        
                        for (const [itemId, qty] of Object.entries(materialsToAdjust)) {
                            const invItem = inventory.find(i => i.id === itemId);
                            if (invItem) {
                                const currentInvQty = parseFloat(invItem.quantity) || 0;
                                const adjustedQty = currentInvQty + (qty * multiplier);
                                
                                updatePromises.push(updateDoc(doc(db, "inventory", itemId), { quantity: adjustedQty }));
                                
                                const movementType = qtyDifference > 0 ? 'Saída' : 'Entrada';
                                const movementDetails = qtyDifference > 0 ? `Ajuste de erro no pedido #${order.id.slice(-4)}` : `Correção de erro no pedido #${order.id.slice(-4)}`;

                                updatePromises.push(addDoc(collection(db, "movements"), {
                                    date: new Date().toISOString(),
                                    type: movementType,
                                    itemId: itemId,
                                    itemName: invItem.name,
                                    quantity: Math.abs(qty),
                                    unitValue: invItem.cost || 0,
                                    entity: 'Produção (Ajuste)',
                                    details: movementDetails
                                }));
                            }
                        }
                    }
                }

                updatePromises.push(updateDoc(doc(db, "productionErrors", currentErrorId), { errorQty: newQty, reason: newReason }));
                await Promise.all(updatePromises);

                alert("Registro de erro atualizado com sucesso.");
                closeEditErrorModal();
                fetchErrors();
                fetchInventory();

            } catch (e) {
                console.error("Erro ao editar registro de erro:", e);
                alert("Erro ao salvar: " + e.message);
            } finally {
                btn.textContent = 'Salvar Alterações';
                btn.disabled = false;
            }
        }

        window.deleteProductionError = async (id) => {
            if (!confirm("Tem certeza que deseja excluir este registro de erro? Os materiais serão devolvidos ao estoque.")) return;

            const errorToDelete = productionErrors.find(e => e.id === id);
            if (!errorToDelete) return;

            try {
                const deletePromises = [];
                const order = window.allOrders.find(o => o.id === errorToDelete.orderId);
                const errorItem = order.items.find(i => i.name === errorToDelete.productName && i.category === errorToDelete.category && i.size === errorToDelete.size);

                if (errorItem) {
                    const materialsToReturn = getMaterialsForErrorItem(errorItem, errorToDelete.errorQty);
                    for (const [itemId, qty] of Object.entries(materialsToReturn)) {
                        const invItem = inventory.find(i => i.id === itemId);
                        if (invItem) {
                            const newQty = (parseFloat(invItem.quantity) || 0) + qty;
                            deletePromises.push(updateDoc(doc(db, "inventory", itemId), { quantity: newQty }));
                            deletePromises.push(addDoc(collection(db, "movements"), { date: new Date().toISOString(), type: 'Entrada', itemId: itemId, itemName: invItem.name, quantity: qty, unitValue: invItem.cost || 0, entity: 'Produção (Correção)', details: `Exclusão de erro no pedido #${order.id.slice(-4)}` }));
                        }
                    }
                }

                deletePromises.push(deleteDoc(doc(db, "productionErrors", id)));
                const remainingErrors = productionErrors.filter(e => e.orderId === errorToDelete.orderId && e.id !== id);
                if (remainingErrors.length === 0) {
                    deletePromises.push(updateDoc(doc(db, "orders", errorToDelete.orderId), { hasError: false }));
                }

                await Promise.all(deletePromises);
                alert("Registro de erro excluído e estoque corrigido.");
                fetchErrors(); fetchInventory(); fetchOrders();
            } catch (e) {
                console.error("Erro ao excluir registro de erro:", e);
                alert("Erro ao excluir: " + e.message);
            }
        }

        window.sendOrderToWhatsapp = async (id) => {
            try {
                const docSnap = await getDoc(doc(db, "orders", id));
                if (!docSnap.exists()) return;
                const order = docSnap.data();
                
                const phone = order.clientPhone.replace(/\D/g, '');
                if (!phone) {
                    alert("Telefone do cliente não informado ou inválido.");
                    return;
                }

                let msg = "";
                if (order.status === 'Finalizado') {
                    msg = `Olá, tudo bem? Seu pedido já está disponível para retirada na secretaria! Importante! No momento da retirada, verifique o nome do responsável e do estudante na etiqueta. Muito Obrigado.`;
                } else {
                    // Mensagem padrão de orçamento/acompanhamento
                    msg = `*Olá ${order.clientName}, segue detalhes do seu pedido:*\n\n`;
                    order.items.forEach(item => {
                        msg += `- ${item.qty}x ${item.name} (${item.category || ''} ${item.size || ''}): R$ ${item.total.toFixed(2)}\n`;
                    });
                    msg += `\n*Total: R$ ${order.total.toFixed(2)}*`;
                    
                    if (order.studentName) msg += `\nAluno: ${order.studentName}`;
                    if (order.observation) msg += `\nObs: ${order.observation}`;
                }
                
                window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            } catch (e) {
                console.error("Erro ao gerar link:", e);
            }
        }

        // --- Lógica de Repasses (Transfers) ---
        let transferList = [];
        let selectedTransferIds = new Set();

        window.fetchTransfers = async () => {
            const tbody = document.getElementById('transfers-table-body');
            tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-muted-foreground">Calculando repasses...</td></tr>';
            
            try {
                // Garantir dados atualizados
                const ordersSnap = await getDocs(collection(db, "orders"));
                const orders = [];
                ordersSnap.forEach(doc => orders.push({id: doc.id, ...doc.data()}));

                if (!window.cachedProducts) {
                    const pSnap = await getDocs(collection(db, "products"));
                    window.cachedProducts = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
                }

                transferList = [];

                // Processar cada pedido para gerar as linhas de repasse
                orders.forEach(order => {
                    if (!order.items) return;

                    // Calcular totais por tipo
                    let schoolTotal = 0;
                    let prodTotal = 0;
                    let admTotal = 0;

                    order.items.forEach(item => {
                        const prod = window.cachedProducts.find(p => p.id === item.productId);
                        if (prod && prod.pricing) {
                            // Tenta achar o preço da categoria específica
                            const pricing = prod.pricing.find(pr => pr.category === item.category) || prod.pricing[0];
                            if (pricing) {
                                schoolTotal += (parseFloat(pricing.schoolCommission) || 0) * item.qty;
                                prodTotal += (parseFloat(pricing.productionCost) || 0) * item.qty;
                                admTotal += (parseFloat(pricing.adminProfit) || 0) * item.qty;
                            }
                        }
                    });

                    // Determinar Status Base do Repasse
                    // Aberto: Pedido não finalizado OU Cliente não pagou tudo
                    // Pendente: Pedido Finalizado/Entregue E Cliente Pagou Tudo (Pronto para pagar parceiro)
                    // Pago: Marcado explicitamente no objeto payouts do pedido

                    const isOrderDone = ['Finalizado', 'Entregue'].includes(order.status);
                    const isClientPaid = order.paymentStatus === 'Pago Total';
                    const payouts = order.payouts || {};

                    const baseStatus = (isOrderDone && isClientPaid) ? 'Pendente' : 'Aberto';

                    // 1. Repasse Escola
                    if (schoolTotal > 0) {
                        const partner = partners.find(p => p.id === order.partnerId);
                        transferList.push({
                            id: `${order.id}_school`,
                            orderId: order.id,
                            date: order.createdAt,
                            clientName: order.clientName,
                            beneficiary: partner ? (partner.nickname || partner.name) : 'Escola Indefinida',
                            partnerId: order.partnerId,
                            type: 'Escola',
                            amount: schoolTotal,
                            status: payouts.school ? 'Pago' : baseStatus,
                            paymentDate: payouts.schoolDate
                        });
                    }

                    // 2. Repasse Produção
                    if (prodTotal > 0) {
                        const producer = partners.find(p => p.id === order.producerId);
                        transferList.push({
                            id: `${order.id}_producer`,
                            orderId: order.id,
                            date: order.createdAt,
                            clientName: order.clientName,
                            beneficiary: producer ? (producer.nickname || producer.name) : 'Produção Geral',
                            partnerId: order.producerId, // Pode ser null se não definido
                            type: 'Produção',
                            amount: prodTotal,
                            status: payouts.producer ? 'Pago' : baseStatus,
                            paymentDate: payouts.producerDate
                        });
                    }

                    // 3. Repasse ADM
                    if (admTotal > 0) {
                        const admPartner = partners.find(p => (p.category || '').trim().toUpperCase() === 'ADM');
                        transferList.push({
                            id: `${order.id}_adm`,
                            orderId: order.id,
                            date: order.createdAt,
                            clientName: order.clientName,
                            beneficiary: admPartner ? (admPartner.nickname || admPartner.name) : 'Caixa Interno',
                            partnerId: admPartner ? admPartner.id : 'ADM',
                            type: 'ADM',
                            amount: admTotal,
                            status: payouts.adm ? 'Pago' : baseStatus,
                            paymentDate: payouts.admDate
                        });
                    }
                });

                renderTransfers();

            } catch (e) {
                console.error("Erro ao calcular repasses:", e);
                tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            }
        }

        function renderTransfers() {
            const tbody = document.getElementById('transfers-table-body');
            const filterPartner = document.getElementById('transferFilterPartner').value;
            const filterType = document.getElementById('transferFilterType').value;
            const filterStatus = document.getElementById('transferFilterStatus').value;

            let filtered = transferList.filter(t => {
                if (filterPartner && t.partnerId !== filterPartner) return false;
                if (filterType && t.type !== filterType) return false;
                if (filterStatus && t.status !== filterStatus) return false;
                return true;
            });

            // Ordenar: Pendente primeiro, depois Aberto, depois Pago
            const statusOrder = { 'Pendente': 1, 'Aberto': 2, 'Pago': 3 };
            filtered.sort((a, b) => statusOrder[a.status] - statusOrder[b.status] || new Date(b.date) - new Date(a.date));

            tbody.innerHTML = '';
            let totalVal = 0;

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-muted-foreground">Nenhum repasse encontrado com os filtros atuais.</td></tr>';
            } else {
                filtered.forEach(t => {
                    totalVal += t.amount;
                    const dateStr = new Date(t.date).toLocaleDateString('pt-BR');
                    
                    let statusBadge = '';
                    if (t.status === 'Aberto') statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Aberto</span>';
                    if (t.status === 'Pendente') statusBadge = '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">Pendente</span>';
                    if (t.status === 'Pago') statusBadge = '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Pago</span>';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="py-3"><input type="checkbox" value="${t.id}" class="transfer-check" onchange="updateTransferSelection()"></td>
                        <td>${dateStr}</td>
                        <td>
                            <div class="font-medium text-gray-800">#${t.orderId.slice(-4)}</div>
                            <div class="text-xs text-gray-500">${t.clientName}</div>
                        </td>
                        <td>${t.beneficiary}</td>
                        <td>${t.type}</td>
                        <td class="font-bold">R$ ${t.amount.toFixed(2)}</td>
                        <td class="text-right">${statusBadge}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('transferTotalDisplay').textContent = `R$ ${totalVal.toFixed(2)}`;
            document.getElementById('transfer-selected-count').textContent = '0';
            selectedTransferIds.clear();
            
            // Desmarcar checkbox geral
            const masterCheck = document.querySelector('input[onchange="toggleAllTransfers(this)"]');
            if(masterCheck) masterCheck.checked = false;
        }

        window.toggleAllTransfers = (source) => {
            const checkboxes = document.querySelectorAll('.transfer-check');
            checkboxes.forEach(cb => {
                cb.checked = source.checked;
            });
            updateTransferSelection();
        }

        window.updateTransferSelection = () => {
            const checkboxes = document.querySelectorAll('.transfer-check:checked');
            selectedTransferIds.clear();
            checkboxes.forEach(cb => selectedTransferIds.add(cb.value));
            document.getElementById('transfer-selected-count').textContent = selectedTransferIds.size;
        }

        window.markSelectedAsPaid = async () => {
            if (selectedTransferIds.size === 0) {
                alert("Selecione pelo menos um repasse para efetivar.");
                return;
            }

            if (!confirm(`Deseja marcar ${selectedTransferIds.size} repasses como PAGOS?`)) return;

            // Agrupar atualizações por Pedido para economizar escritas
            const updatesByOrder = {};

            selectedTransferIds.forEach(compositeId => {
                // compositeId ex: "order123_school"
                const [orderId, typeKey] = compositeId.split('_'); // typeKey será 'school', 'producer', ou 'adm'
                
                if (!updatesByOrder[orderId]) updatesByOrder[orderId] = {};
                updatesByOrder[orderId][`payouts.${typeKey}`] = true;
                updatesByOrder[orderId][`payouts.${typeKey}Date`] = new Date().toISOString();
            });

            try {
                const promises = Object.keys(updatesByOrder).map(orderId => {
                    return updateDoc(doc(db, "orders", orderId), updatesByOrder[orderId]);
                });

                await Promise.all(promises);
                alert("Pagamentos efetivados com sucesso!");
                fetchTransfers();
            } catch (e) {
                console.error("Erro ao efetivar pagamentos:", e);
                alert("Erro ao atualizar dados.");
            }
        }

        // --- Histórico de Pagamentos ---
        window.openPaymentHistoryModal = () => {
            const modal = document.getElementById('paymentHistoryModal');
            const tbody = document.getElementById('paymentHistoryBody');
            
            // Filtrar apenas os pagos
            const paidTransfers = transferList.filter(t => t.status === 'Pago');
            
            // Ordenar por data de pagamento (mais recente primeiro)
            paidTransfers.sort((a, b) => {
                const dateA = a.paymentDate ? new Date(a.paymentDate) : new Date(0);
                const dateB = b.paymentDate ? new Date(b.paymentDate) : new Date(0);
                return dateB - dateA;
            });

            tbody.innerHTML = '';
            if (paidTransfers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-muted-foreground">Nenhum pagamento registrado no histórico.</td></tr>';
            } else {
                paidTransfers.forEach(t => {
                    const dateStr = t.paymentDate ? new Date(t.paymentDate).toLocaleDateString('pt-BR') + ' ' + new Date(t.paymentDate).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '-';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3">${dateStr}</td>
                        <td class="px-4 py-3 font-medium">${t.beneficiary}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${t.type}</span></td>
                        <td class="px-4 py-3 text-xs text-gray-500">#${t.orderId.slice(-4)} - ${t.clientName}</td>
                        <td class="px-4 py-3 text-right font-bold text-green-700">R$ ${t.amount.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // --- Impressão de Etiqueta (48mm) ---
        window.printOrderLabel = async (id) => {
            try {
                // Buscar dados atualizados do pedido
                const docSnap = await getDoc(doc(db, "orders", id));
                if (!docSnap.exists()) return;
                const order = docSnap.data();

                // Buscar nome da escola
                const partner = partners.find(p => p.id === order.partnerId);
                const schoolName = partner ? (partner.nickname || partner.name) : 'Geral';

                // Construir HTML da etiqueta
                const printWindow = window.open('', '', 'width=400,height=600');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Etiqueta Pedido #${id.slice(-4)}</title>
                        <style>
                            @page { size: 48mm auto; margin: 0; }
                            body { 
                                width: 48mm; 
                                font-family: sans-serif; 
                                font-size: 12px; 
                                margin: 0; 
                                padding: 2mm; 
                                color: black;
                            }
                            .header { font-weight: bold; font-size: 14px; text-align: center; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 5px; text-transform: uppercase; }
                            .row { margin-bottom: 4px; line-height: 1.2; }
                            .label { font-weight: bold; font-size: 10px; text-transform: uppercase; }
                            .value { font-size: 12px; font-weight: bold; }
                            .items-container { margin-top: 8px; border-top: 1px dashed black; padding-top: 5px; }
                            .item { font-size: 11px; margin-bottom: 3px; }
                            .item-meta { font-size: 9px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">${schoolName}</div>
                        
                        <div class="row"><div class="label">Cliente:</div><div class="value">${order.clientName}</div></div>
                        ${order.studentName ? `<div class="row"><div class="label">Estudante:</div><div class="value">${order.studentName}</div></div>` : ''}
                        
                        <div class="items-container">
                            ${order.items.map(i => `<div class="item"><strong>${i.qty}x</strong> ${i.name}<br><span class="item-meta">${i.category || ''} - ${i.size}</span></div>`).join('')}
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
            } catch (e) {
                console.error("Erro ao imprimir etiqueta:", e);
                alert("Erro ao gerar etiqueta.");
            }
        }

        // --- Automação de Arquivamento (30 dias após Entregue) ---
        async function checkAutoArchive() {
            try {
                const querySnapshot = await getDocs(collection(db, "orders"));
                const now = new Date();
                const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
                
                querySnapshot.forEach(async (docSnap) => {
                    const order = docSnap.data();
                    
                    if (order.status === 'Entregue') {
                        // Usa deliveredAt se existir, senão usa updatedAt como fallback
                        const dateRef = order.deliveredAt ? new Date(order.deliveredAt) : (order.updatedAt ? new Date(order.updatedAt) : null);
                        
                        if (dateRef) {
                            const diff = now - dateRef;
                            if (diff > thirtyDaysInMs) {
                                console.log(`Arquivando pedido ${docSnap.id} automaticamente.`);
                                await updateDoc(doc(db, "orders", docSnap.id), { status: 'Arquivado' });
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Erro na automação de arquivamento:", e);
            }
        }

        // Inicializar
        fetchPartners();
    </script>

    <script>
        lucide.createIcons();

        function switchTab(tabId) {
            if (tabId === 'transfers') {
                fetchTransfers();
            }
            if (tabId === 'errors') {
                fetchErrors();
            }
            if (tabId === 'overview') {
                fetchOrders(); // Recarrega dados para o dashboard
            }

            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            // Deactivate all buttons
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
                el.classList.add('text-muted-foreground');
            });

            // Show selected content
            document.getElementById(tabId).classList.add('active');
            
            // Activate selected button
            const btn = document.getElementById('btn-' + tabId);
            if(btn) {
                btn.classList.add('active');
                btn.classList.remove('text-muted-foreground');
            }
        }

        function logout() {
            sessionStorage.removeItem('auth');
            window.location.href = 'index.html';
        }

        // --- Dashboard Logic ---
        async function renderDashboard() {
            const orders = window.allOrders;
            if (!orders || orders.length === 0) return;

            // 1. Métricas Financeiras (Mês Atual)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let salesMonth = 0;
            let totalTransfersMonth = 0;
            let totalMaterialCostMonth = 0;
            let totalExternalTransfersMonth = 0; // Escola + Produção

            // Garantir produtos carregados para cálculos
            if (!window.cachedProducts) {
                const pSnap = await getDocs(collection(db, "products"));
                window.cachedProducts = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
            }

            orders.forEach(order => {
                const d = new Date(order.createdAt);
                if (d.getMonth() === currentMonth && d.getFullYear() === currentYear && order.status !== 'Orçamento' && order.status !== 'Arquivado') {
                    salesMonth += order.total || 0;

                    // Calcular Repasses e Custos deste pedido
                    if (order.items) {
                        order.items.forEach(item => {
                            // Custo Material (Malha)
                            const malhaItem = inventory.find(i => i.type === 'Malha' && i.name === item.size && i.category === item.category);
                            if (malhaItem) totalMaterialCostMonth += (parseFloat(malhaItem.cost) || 0) * item.qty;

                            // Custo Material (Estampa)
                            const prod = window.cachedProducts.find(p => p.id === item.productId);
                            if (prod) {
                                if (prod.printId) {
                                    const printItem = inventory.find(i => i.id === prod.printId);
                                    if (printItem) totalMaterialCostMonth += (parseFloat(printItem.cost) || 0) * item.qty;
                                }
                                // Repasses
                                if (prod.pricing) {
                                    const pricing = prod.pricing.find(pr => pr.category === item.category) || prod.pricing[0];
                                    if (pricing) {
                                        const school = (parseFloat(pricing.schoolCommission) || 0) * item.qty;
                                        const prodCost = (parseFloat(pricing.productionCost) || 0) * item.qty;
                                        const adm = (parseFloat(pricing.adminProfit) || 0) * item.qty;
                                        
                                        totalTransfersMonth += (school + prodCost + adm);
                                        totalExternalTransfersMonth += (school + prodCost);
                                    }
                                }
                            }
                        });
                        
                        // Custo Insumos (Estimativa simples unitária para dashboard)
                        inventory.filter(i => i.type === 'Insumo').forEach(insumo => {
                            const r = insumo.usageRule || {type:'unit', qty:1};
                            if(r.type==='unit') totalMaterialCostMonth += (parseFloat(insumo.cost)||0) * (order.items.reduce((a,b)=>a+b.qty,0) * r.qty);
                        });
                    }
                }
            });

            const netProfit = salesMonth - totalMaterialCostMonth - totalExternalTransfersMonth;

            document.getElementById('dashSalesMonth').textContent = `R$ ${salesMonth.toFixed(2)}`;
            document.getElementById('dashNetProfit').textContent = `R$ ${netProfit.toFixed(2)}`;
            document.getElementById('dashTotalTransfers').textContent = `R$ ${totalTransfersMonth.toFixed(2)}`;

            // 2. Listas de Pedidos
            const renderMiniCard = (order, containerId) => {
                const container = document.getElementById(containerId);
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer';
                div.onclick = () => { 
                    // Atalho para abrir modal ou ir para aba
                    if(order.status === 'Orçamento') window.openOrderModal(order.id);
                    else { switchTab('production'); switchProductionStatus(order.status); }
                };
                
                const partner = partners.find(p => p.id === order.partnerId);
                const partnerName = partner ? (partner.nickname || partner.name) : 'Geral';

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-xs text-gray-800 truncate w-2/3">${order.clientName}</span>
                        <span class="text-[10px] text-gray-400">#${order.id.slice(-4)}</span>
                    </div>
                    <div class="text-[10px] text-gray-500 mb-1">${partnerName}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-primary">R$ ${parseFloat(order.total).toFixed(2)}</span>
                        <span class="text-[10px] bg-gray-100 px-1 rounded">${new Date(order.createdAt).toLocaleDateString('pt-BR')}</span>
                    </div>
                `;
                container.appendChild(div);
            };

            document.getElementById('dashListBudget').innerHTML = '';
            document.getElementById('dashListPending').innerHTML = '';
            document.getElementById('dashListProduction').innerHTML = '';

            // Ordenar por data decrescente
            const sortedOrders = [...orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            sortedOrders.forEach(order => {
                if (order.status === 'Orçamento') renderMiniCard(order, 'dashListBudget');
                else if (order.status === 'Pendente') renderMiniCard(order, 'dashListPending');
                else if (order.status === 'Produção') renderMiniCard(order, 'dashListProduction');
            });
        }
    </script>
</body>
</html>